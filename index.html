<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<meta name="theme-color" content="#003B6F"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="TARDIS"/>
<link rel="manifest" href="./manifest.json"/>
<link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9ImJnIiB4MT0iMCUiIHkxPSIwJSIgeDI9IjAlIiB5Mj0iMTAwJSI+PHN0b3Agb2Zmc2V0PSIwJSIgc3R5bGU9InN0b3AtY29sb3I6IzJkNGM2NSIvPjxzdG9wIG9mZnNldD0iMTAwJSIgc3R5bGU9InN0b3AtY29sb3I6IzFhMzU0OCIvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSJ0cmFuc3BhcmVudCIvPjxyZWN0IHg9IjQ1IiB5PSI1IiB3aWR0aD0iMTAiIGhlaWdodD0iNCIgZmlsbD0iIzI4NTBhMCIgc3Ryb2tlPSIjMDAwIiBzdHJva2Utd2lkdGg9IjAuNSIvPjxyZWN0IHg9IjQ3LjUiIHk9IjMiIHdpZHRoPSI1IiBoZWlnaHQ9IjIiIGZpbGw9IiNmZmNjMDAiLz48cmVjdCB4PSIzNSIgeT0iOS41IiB3aWR0aD0iMzAiIGhlaWdodD0iNyIgZmlsbD0iIzAwMTUzMyIvPjx0ZXh0IHg9IjUwIiB5PSIxNC41IiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iNSIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IiNmZmYiIHRleHQtYW5jaG9yPSJtaWRkbGUiPlBPTElDRSBCT1g8L3RleHQ+PHJlY3QgeD0iMzAiIHk9IjE2LjUiIHdpZHRoPSI0MCIgaGVpZ2h0PSI3MCIgZmlsbD0idXJsKCNiZykiIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLXdpZHRoPSIxLjUiLz48cmVjdCB4PSIzNCIgeT0iMjEiIHdpZHRoPSI4IiBoZWlnaHQ9IjkiIGZpbGw9IiNkZGVlZmYiIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLXdpZHRoPSIwLjgiLz48cmVjdCB4PSI0NSIgeT0iMjEiIHdpZHRoPSI4IiBoZWlnaHQ9IjkiIGZpbGw9IiNkZGVlZmYiIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLXdpZHRoPSIwLjgiLz48cmVjdCB4PSI1NiIgeT0iMjEiIHdpZHRoPSI4IiBoZWlnaHQ9IjkiIGZpbGw9IiNkZGVlZmYiIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLXdpZHRoPSIwLjgiLz48cmVjdCB4PSIzNCIgeT0iMzMiIHdpZHRoPSI4IiBoZWlnaHQ9IjkiIGZpbGw9IiNkZGVlZmYiIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLXdpZHRoPSIwLjgiLz48cmVjdCB4PSI0NSIgeT0iMzMiIHdpZHRoPSI4IiBoZWlnaHQ9IjkiIGZpbGw9IiNkZGVlZmYiIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLXdpZHRoPSIwLjgiLz48cmVjdCB4PSI1NiIgeT0iMzMiIHdpZHRoPSI4IiBoZWlnaHQ9IjkiIGZpbGw9IiNkZGVlZmYiIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLXdpZHRoPSIwLjgiLz48cmVjdCB4PSI0MCIgeT0iNTAiIHdpZHRoPSIyMCIgaGVpZ2h0PSIyOCIgZmlsbD0iIzhhOGE3NSIgc3Ryb2tlPSIjMDAwIiBzdHJva2Utd2lkdGg9IjEiLz48cmVjdCB4PSI0MiIgeT0iNTIiIHdpZHRoPSI3IiBoZWlnaHQ9IjI0IiBmaWxsPSIjNzA3MDYwIiBzdHJva2U9IiMwMDAiIHN0cm9rZS13aWR0aD0iMC41Ii8+PHJlY3QgeD0iNTEiIHk9IjUyIiB3aWR0aD0iNyIgaGVpZ2h0PSIyNCIgZmlsbD0iIzcwNzA2MCIgc3Ryb2tlPSIjMDAwIiBzdHJva2Utd2lkdGg9IjAuNSIvPjxyZWN0IHg9IjMwIiB5PSI4MC41IiB3aWR0aD0iNDAiIGhlaWdodD0iNiIgZmlsbD0iIzAwMCIvPjwvc3ZnPg==" type="image/svg+xml"/>
<title>Dr. Way's T.A.R.D.I.S.</title>   
<style>
*{box-sizing:border-box;margin:0;padding:0}body{font-family:'Segoe UI',sans-serif;background:#f0f2f5;min-height:100vh}button{cursor:pointer;font-family:inherit}input,select,textarea{font-family:inherit;border:1px solid #ccc;border-radius:6px;padding:6px 10px;font-size:14px;width:100%}textarea{resize:vertical}
.B{border-radius:8px;padding:8px 16px;font-size:14px;font-weight:600;border:2px solid transparent;cursor:pointer}.Bs{padding:4px 10px;font-size:12px;border-radius:8px;font-weight:600;border:2px solid transparent;cursor:pointer}
.Bp{background:#003B6F;color:#fff}.Bd{background:#c0392b;color:#fff}.Bo{background:transparent;color:#003B6F;border-color:#003B6F}.Bg{background:#27ae60;color:#fff}
.C{background:#fff;border-radius:12px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,.08);margin-bottom:12px}
.badge{border-radius:20px;padding:2px 8px;font-size:11px;font-weight:700;margin-left:4px;display:inline-block;color:#fff}
.M{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;display:flex;align-items:center;justify-content:center;padding:16px}.Mb{background:#fff;border-radius:16px;padding:20px;width:100%;max-width:500px;max-height:90vh;overflow-y:auto}
.T{background:#fff;border-bottom:2px solid #eee;overflow-x:auto;display:flex;white-space:nowrap}.Ti{padding:8px 10px;background:none;border:none;border-bottom:3px solid transparent;color:#666;cursor:pointer;font-weight:400;font-size:11px;display:inline-flex;flex-direction:column;align-items:center;gap:2px;min-width:48px}.Ti.a{color:#003B6F;border-bottom-color:#003B6F;font-weight:700}
.S{display:flex;gap:4px;margin-bottom:12px;overflow-x:auto;padding-bottom:2px}.Si{padding:6px 12px;border-radius:8px;border:none;background:#eee;color:#333;cursor:pointer;font-weight:700;font-size:12px;white-space:nowrap}.Si.a{background:#003B6F;color:#fff}
.H{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;flex-wrap:wrap;gap:6px}.H h3{margin:0;font-size:16px;color:#003B6F}.Ha{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:8px}.fl{font-size:12px;display:block;margin-bottom:2px;color:#555}
.ep{font-size:10px;border-radius:4px;padding:2px 6px;margin-bottom:2px;white-space:nowrap;text-overflow:ellipsis;overflow:hidden;color:#fff}
.pb{background:#eee;border-radius:99px;height:8px;overflow:hidden}.pf{height:100%;border-radius:99px}
.kw{display:flex;gap:8px;overflow-x:auto;padding-bottom:8px}.kc{min-width:160px;flex:0 0 160px;background:#f0f4ff;border-radius:8px;padding:8px}
.hcol{display:flex;flex-direction:column;flex:1;min-width:80px;border-right:1px solid #eee}.hcol:last-child{border-right:none}
#ct{max-width:640px;margin:0 auto;padding:14px 12px}
.drag-over{outline:2px dashed #003B6F;outline-offset:-2px}.dragging{opacity:.4}
.install-prompt{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#003B6F;color:#fff;padding:12px 20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.3);display:none;z-index:2000;align-items:center;gap:12px}.install-prompt.show{display:flex}
.editable{cursor:pointer;padding:2px 4px;border-radius:4px;transition:background 0.2s}.editable:hover{background:#f0f4ff}
#voiceBtn{position:fixed;bottom:80px;right:20px;width:56px;height:56px;border-radius:50%;background:#003B6F;color:#fff;border:none;font-size:24px;cursor:pointer;box-shadow:0 4px 14px rgba(0,59,111,.5);z-index:1500;display:flex;align-items:center;justify-content:center;transition:all .2s}
#voiceBtn.listening{background:#e74c3c;animation:pulse 1s infinite}
#voiceBtn.processing{background:#f39c12}
@keyframes pulse{0%,100%{transform:scale(1);box-shadow:0 4px 14px rgba(231,76,60,.5)}50%{transform:scale(1.1);box-shadow:0 6px 20px rgba(231,76,60,.7)}}
#voicePanel{position:fixed;bottom:148px;right:20px;background:#fff;border-radius:16px;padding:16px;width:300px;max-width:90vw;box-shadow:0 8px 30px rgba(0,0,0,.15);z-index:1500;display:none;flex-direction:column;gap:10px}
#voicePanel.show{display:flex}
#voiceTranscript{background:#f0f4ff;border-radius:8px;padding:10px;font-size:13px;color:#333;min-height:48px;max-height:120px;overflow-y:auto;border:1px solid #dde4ff}
#voiceResult{background:#f0fff4;border-radius:8px;padding:10px;font-size:13px;color:#27ae60;min-height:36px;display:none}
#voiceStatus{font-size:11px;color:#888;text-align:center}
#voiceHelpBtn{font-size:11px;color:#003B6F;background:none;border:none;cursor:pointer;text-decoration:underline;text-align:center}
</style></head><body><div id="root"></div>
<div id="installPrompt" class="install-prompt">
  <span>Install TARDIS as an app?</span>
  <button onclick="installPWA()" style="background:#fff;color:#003B6F;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-weight:600">Install</button>
  <button onclick="dismissInstall()" style="background:transparent;color:#fff;border:1px solid #fff;padding:6px 12px;border-radius:6px;cursor:pointer">Later</button>
</div>

<div id="voicePanel">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <strong style="color:#003B6F;font-size:14px">üéôÔ∏è Voice Assistant</strong>
    <button onclick="closeVoicePanel()" style="background:none;border:none;font-size:18px;cursor:pointer;color:#666">‚úï</button>
  </div>
  <div id="voiceTranscript">Say something like:<br><em>"Add task buy milk"</em><br><em>"Add grocery eggs"</em><br><em>"Log workout run 30 minutes"</em><br><em>"Add note to journal feeling great today"</em></div>
  <div id="voiceResult"></div>
  <div id="voiceStatus">Tap üéôÔ∏è to start speaking</div>
  <button id="voiceHelpBtn" onclick="showVoiceHelp()">Show all voice commands</button>
</div>
<button id="voiceBtn" onclick="toggleVoice()" title="Voice Assistant">üéôÔ∏è</button>

<script>
// ‚îÄ‚îÄ PWA: Inject manifest.json as a Blob URL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function injectManifest(){
  const ICON_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><linearGradient id="bg" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:#2d4c65"/><stop offset="100%" style="stop-color:#1a3548"/></linearGradient></defs><rect width="100" height="100" fill="#003B6F"/><rect x="45" y="5" width="10" height="4" fill="#2850a0" stroke="#000" stroke-width="0.5"/><rect x="47.5" y="3" width="5" height="2" fill="#ffcc00"/><rect x="35" y="9.5" width="30" height="7" fill="#001533"/><text x="50" y="14.5" font-family="Arial,sans-serif" font-size="5" font-weight="bold" fill="#fff" text-anchor="middle">POLICE BOX</text><rect x="30" y="16.5" width="40" height="70" fill="url(#bg)" stroke="#000" stroke-width="1.5"/><rect x="34" y="21" width="8" height="9" fill="#ddeeff" stroke="#000" stroke-width="0.8"/><rect x="45" y="21" width="8" height="9" fill="#ddeeff" stroke="#000" stroke-width="0.8"/><rect x="56" y="21" width="8" height="9" fill="#ddeeff" stroke="#000" stroke-width="0.8"/><rect x="34" y="33" width="8" height="9" fill="#ddeeff" stroke="#000" stroke-width="0.8"/><rect x="45" y="33" width="8" height="9" fill="#ddeeff" stroke="#000" stroke-width="0.8"/><rect x="56" y="33" width="8" height="9" fill="#ddeeff" stroke="#000" stroke-width="0.8"/><rect x="40" y="50" width="20" height="28" fill="#8a8a75" stroke="#000" stroke-width="1"/><rect x="42" y="52" width="7" height="24" fill="#707060" stroke="#000" stroke-width="0.5"/><rect x="51" y="52" width="7" height="24" fill="#707060" stroke="#000" stroke-width="0.5"/><rect x="30" y="80.5" width="40" height="6" fill="#000"/></svg>`;
  const svgBlob = new Blob([ICON_SVG],{type:'image/svg+xml'});
  const svgUrl = URL.createObjectURL(svgBlob);
  const manifest = {
    name:"Dr. Way's T.A.R.D.I.S.",
    short_name:"TARDIS",
    description:"Time And Relative Dimension In Scheduling ‚Äì Dr. Way's personal organizer",
    start_url:"./",
    display:"standalone",
    background_color:"#003B6F",
    theme_color:"#003B6F",
    orientation:"portrait-primary",
    icons:[
      {src:svgUrl,sizes:"192x192",type:"image/svg+xml",purpose:"any maskable"},
      {src:svgUrl,sizes:"512x512",type:"image/svg+xml",purpose:"any maskable"}
    ],
    categories:["productivity","utilities"],
    shortcuts:[
      {name:"Today's Tasks",short_name:"Tasks",description:"View today's tasks",url:"./"},
      {name:"Calendar",short_name:"Calendar",description:"View calendar",url:"./"}
    ]
  };
  const mBlob = new Blob([JSON.stringify(manifest)],{type:'application/json'});
  const mUrl = URL.createObjectURL(mBlob);
  document.getElementById('manifestLink').href = mUrl;
})();

// ‚îÄ‚îÄ PWA: Register Service Worker via Blob URL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Service Worker note: SW registration from a single HTML file is not possible
// due to browser same-origin security rules (blob: URLs are blocked).
// To enable offline/SW support, save this file to a web server and add a
// separate sw.js file. The manifest below still enables installability on http/https.
window._swStatus = 'unavailable';

const P="#003B6F",PL="#004F9A",GL="#C9A84C",TD=new Date().toISOString().slice(0,10),uid=()=>Math.random().toString(36).slice(2,9),fmt=d=>d?new Date(d+"T00:00:00").toLocaleDateString("en-US",{month:"short",day:"numeric"}):"",fm$=n=>"$"+Number(n||0).toFixed(2);
const BK=["Personal","Way Forged LLC","CLO Work","Home","Athletics","Blacksmith","Row & Throw","Learning","Pets"],PR=["High","Medium","Low"],ST=["Not Started","In Progress","On Hold","Waiting","Review","Complete"],RC=["None","Daily","Weekdays","Weekly","Biweekly","Monthly"],WT=["Walk","Run","Swim","Lift","Erg","Row","Throw","Yoga","HIIT","Other"];
const PC={High:"#e74c3c",Medium:"#f39c12",Low:"#27ae60"},BC={"Personal":"#6c63ff","Way Forged LLC":GL,"CLO Work":"#2980b9","Home":"#27ae60","Athletics":"#e67e22","Blacksmith":"#7f8c8d","Row & Throw":"#16a085","Learning":"#8e44ad","Pets":"#e91e8c"};
// ‚îÄ‚îÄ Crypto helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function hashPw(pw){
  const buf=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(pw));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}
async function deriveKey(pw,saltHex){
  const salt=new Uint8Array(saltHex.match(/.{2}/g).map(b=>parseInt(b,16)));
  const base=await crypto.subtle.importKey('raw',new TextEncoder().encode(pw),{name:'PBKDF2'},false,['deriveKey']);
  return crypto.subtle.deriveKey({name:'PBKDF2',salt,iterations:100000,hash:'SHA-256'},base,{name:'AES-GCM',length:256},false,['encrypt','decrypt']);
}
function randHex(n){return Array.from(crypto.getRandomValues(new Uint8Array(n))).map(b=>b.toString(16).padStart(2,'0')).join('');}
async function enc(plaintext,pw){
  try{
    const salt=randHex(16),iv=randHex(12);
    const key=await deriveKey(pw,salt);
    const ct=await crypto.subtle.encrypt({name:'AES-GCM',iv:new Uint8Array(iv.match(/.{2}/g).map(b=>parseInt(b,16)))},key,new TextEncoder().encode(plaintext));
    return salt+'|'+iv+'|'+btoa(String.fromCharCode(...new Uint8Array(ct)));
  }catch{return'';}
}
async function dec(ciphertext,pw){
  try{
    const[salt,iv,ct]=ciphertext.split('|');
    if(!salt||!iv||!ct)return'';
    const key=await deriveKey(pw,salt);
    const pt=await crypto.subtle.decrypt({name:'AES-GCM',iv:new Uint8Array(iv.match(/.{2}/g).map(b=>parseInt(b,16)))},key,Uint8Array.from(atob(ct),c=>c.charCodeAt(0)));
    return new TextDecoder().decode(pt);
  }catch{return'';}
}
const ms={},st={async get(k){try{if(window.storage){const r=await window.storage.get(k);return r?JSON.parse(r.value):null;}}catch{}return ms[k]??null;},async set(k,v){try{if(window.storage)await window.storage.set(k,JSON.stringify(v));}catch{}ms[k]=v;}};
const DCLO=[{id:"c1",name:"Teaching Dates & Programs",poc:"",tasks:[],subs:[]},{id:"c2",name:"Cindy Tasks - T&A",poc:"",tasks:[],subs:[]},{id:"c3",name:"Cindy Tasks - Maxiflex",poc:"",tasks:[],subs:[]},{id:"c4",name:"Cindy Tasks - Leadership Notes",poc:"",tasks:[],subs:[]},{id:"c5",name:"Strategy",poc:"",tasks:[],subs:[]},{id:"c6",name:"Team Reminders",poc:"",tasks:[],subs:[]},{id:"c7",name:"Notes for Ldr Meetings",poc:"",tasks:[],subs:[]},{id:"c8",name:"Team To Do",poc:"",tasks:[],subs:[]},{id:"c9",name:"Performance Mgmt",poc:"",tasks:[],subs:[],desc:"Quarterly Reviews & Bell Curve"},{id:"c10",name:"Leader Dev - Programs",poc:"",tasks:[],subs:[],desc:"SUTS, SLP, Coaching, LLMP, Progression, SF182, Fed Talent, Mandatory Training, LEAP/LEAG, WHLDP"},{id:"c11",name:"Data & Assessments - NTNA",poc:"",tasks:[],subs:[]}];
const ACRS=["Coaching","Weight Class","Social Media","Races","Highland Games - Dates","Highland Games - Throw Tips"];
const DFLT_HCK=[{id:"hc1",text:"Have wallet, keys, phone",done:0},{id:"hc2",text:"Oven is off",done:0},{id:"hc3",text:"Windows are closed",done:0},{id:"hc4",text:"Doors locked",done:0},{id:"hc5",text:"Door downstairs is locked",done:0},{id:"hc6",text:"Animals in the house and safe",done:0},{id:"hc7",text:"Animals have plenty of water",done:0},{id:"hc8",text:"Forge is cold and off",done:0},{id:"hc9",text:"Temperature in the house is OK or changed as needed",done:0},{id:"hc10",text:"Spare key is in the dropbox and accessible",done:0}];

let S={unlocked:0,pw:"",tab:"today",tasks:[],rec:[],settings:{deviceName:"MyDevice"},calEv:[],icsEv:[],cloCats:null,wfP:[],exp:{personal:[],wayForged:[]},inc:{personal:0,wayForged:0},jour:[],rGear:["Oar","Life Jacket","Water Bottle","Seat Pad","Gloves","Sunscreen","Change of Clothes","Racing Shirts","Trunk Trunks","Water","Sunscreen & Bug Spray","Shoes","Snack","Electrolytes","A Book","Video Camera & Batteries","Phone Charger","Biofreeze"],tGear:["Hammer","Weight for Distance","Sheaf","Caber","Braemar Stone","Open Stone","Javelin","Discus","Athletic Shoes","Kilt/Outfit"],acr:null,bsG:["Hammer","Cross Peen","Tongs","Anvil","Apron","Face Shield","Gloves","Coal/Gas","Quench Bucket"],bsP:[],bsPdf:[],pets:[{id:"pw",name:"Wilbur",tr:[],ap:[],gm:[]},{id:"ps",name:"Simba",tr:[],ap:[],gm:[]}],meals:[],wk:[],swk:[],gM:[],lP:[],subs:[{id:"s1",name:"Simba Food"},{id:"s2",name:"Wilbur Food"},{id:"s3",name:"Transparent Labs"},{id:"s4",name:"Humm Nutrition"},{id:"s5",name:"Kaged"},{id:"s6",name:"Dropps"}],bills:[],maint:[],rem:[],creds:{},houseCk:null,homeLinks:[],lastBillReset:"",morningCk:[],eveningCk:[],
cloLinks:[],wfLinks:[],rowLinks:[],throwLinks:[],bsLinks:[],learnLinks:[],petLinks:[],
u:{ts:"tasks",cc:TD,tf:"All",cv:"dash",cx:null,wx:null,bt:"personal",sf:"All",rs:"gear",tw:"gear",bss:"checklist",bsx:null,pa:"pw",ps:"training",hs:"nutrition",lf:"All",ht:"bills",sc:0,ae:{},wk:"clo",lk:"grocery",sk:"rowing",mk:"learning",bf:"All",calView:"week"}};

const KS=["tasks","rec","settings","calEv","icsEv","cloCats","wfP","exp","inc","jour","rGear","tGear","acr","bsG","bsP","bsPdf","pets","meals","wk","swk","gM","lP","subs","bills","maint","rem","pw","creds","houseCk","homeLinks","lastBillReset","morningCk","eveningCk","cloLinks","wfLinks","rowLinks","throwLinks","bsLinks","learnLinks","petLinks"];
let dragIdx=null;

let deferredPrompt;
window.addEventListener('beforeinstallprompt',(e)=>{e.preventDefault();deferredPrompt=e;const prompt=document.getElementById('installPrompt');if(prompt&&!localStorage.getItem('installDismissed')){prompt.classList.add('show');}});
function installPWA(){if(deferredPrompt){deferredPrompt.prompt();deferredPrompt.userChoice.then(()=>{deferredPrompt=null;document.getElementById('installPrompt').classList.remove('show');});}else{alert('App already installed or install not available');}}
function dismissInstall(){document.getElementById('installPrompt').classList.remove('show');localStorage.setItem('installDismissed','true');}
window.addEventListener('appinstalled',()=>{deferredPrompt=null;});

// ‚îÄ‚îÄ Voice Assistant ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let voiceRec=null,voiceListening=false,voicePanelOpen=false,voiceSilenceTimer=null,voiceFinalText='';
const VOICE_SILENCE_MS=2000;

function closeVoicePanel(){voicePanelOpen=false;document.getElementById('voicePanel').classList.remove('show');if(voiceListening)stopVoice();}
function toggleVoice(){if(!voicePanelOpen){voicePanelOpen=true;document.getElementById('voicePanel').classList.add('show');setVoiceStatus('Tap üéôÔ∏è to start speaking');}if(voiceListening){stopVoice();}else{startVoice();}}

function startVoice(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){setVoiceStatus('‚ùå Speech recognition not supported. Try Chrome/Edge.');return;}
  voiceRec=new SR();voiceRec.continuous=true;voiceRec.interimResults=true;voiceRec.lang='en-US';
  const btn=document.getElementById('voiceBtn'),tr=document.getElementById('voiceTranscript'),rs=document.getElementById('voiceResult');
  rs.style.display='none';tr.textContent='üéôÔ∏è Listening‚Ä¶ (pause when done)';
  voiceFinalText='';
  if(voiceSilenceTimer){clearTimeout(voiceSilenceTimer);voiceSilenceTimer=null;}

  voiceRec.onresult=e=>{
    let interim='',final='';
    for(let i=0;i<e.results.length;i++){
      if(e.results[i].isFinal)final+=e.results[i][0].transcript+' ';
      else interim+=e.results[i][0].transcript;
    }
    if(final)voiceFinalText=final.trim();
    tr.textContent=(voiceFinalText||(interim||'üéôÔ∏è Listening‚Ä¶'));
    if(voiceSilenceTimer){clearTimeout(voiceSilenceTimer);voiceSilenceTimer=null;}
    if(voiceFinalText||interim){
      voiceSilenceTimer=setTimeout(()=>{
        if(voiceListening){setVoiceStatus('‚úã Paused ‚Äì submitting‚Ä¶');stopVoice();}
      },VOICE_SILENCE_MS);
    }
  };

  voiceRec.onend=()=>{
    voiceListening=false;
    btn.classList.remove('listening');btn.textContent='üéôÔ∏è';
    if(voiceSilenceTimer){clearTimeout(voiceSilenceTimer);voiceSilenceTimer=null;}
    const spoken=(voiceFinalText||document.getElementById('voiceTranscript').textContent).trim();
    if(spoken&&spoken!=='üéôÔ∏è Listening‚Ä¶ (pause when done)'&&spoken!=='üéôÔ∏è Listening‚Ä¶'){
      btn.classList.add('processing');btn.textContent='‚è≥';
      setVoiceStatus('Processing‚Ä¶');
      processVoiceCommand(spoken);
    }else{setVoiceStatus('Nothing heard. Tap üéôÔ∏è to try again.');}
  };

  voiceRec.onerror=err=>{
    if(err.error==='no-speech')return;
    voiceListening=false;btn.classList.remove('listening');btn.textContent='üéôÔ∏è';
    setVoiceStatus('‚ùå Error: '+err.error+'. Tap to retry.');
  };

  voiceRec.start();voiceListening=true;
  btn.classList.add('listening');btn.textContent='‚èπÔ∏è';
  setVoiceStatus('üéôÔ∏è Listening‚Ä¶ speak, then pause 2s');
}

function stopVoice(){
  if(voiceSilenceTimer){clearTimeout(voiceSilenceTimer);voiceSilenceTimer=null;}
  if(voiceRec)try{voiceRec.stop();}catch(e){}
  voiceListening=false;
  const btn=document.getElementById('voiceBtn');
  btn.classList.remove('listening');btn.textContent='üéôÔ∏è';
}

function setVoiceStatus(msg){const el=document.getElementById('voiceStatus');if(el)el.textContent=msg;}
function showVoiceResult(msg,ok=true){
  const rs=document.getElementById('voiceResult');
  rs.style.display='block';rs.style.background=ok?'#f0fff4':'#fff0f0';rs.style.color=ok?'#27ae60':'#e74c3c';rs.textContent=msg;
  document.getElementById('voiceBtn').classList.remove('processing');document.getElementById('voiceBtn').textContent='üéôÔ∏è';
  setVoiceStatus('Tap üéôÔ∏è to speak again');
}

function voiceConfirm(summary,fields,onConfirm){
  let _saved=false;
  const rs=document.getElementById('voiceResult');
  rs.style.display='block';rs.style.background='#fff8e1';rs.style.color='#555';
  rs.innerHTML='';
  const title=document.createElement('div');title.style.cssText='font-weight:700;margin-bottom:6px;color:#003B6F';title.textContent='Ready to save:';rs.appendChild(title);
  const fieldEls={};
  fields.forEach(f=>{
    const row=document.createElement('div');row.style.cssText='display:flex;gap:6px;align-items:center;margin-bottom:4px';
    const lbl=document.createElement('label');lbl.style.cssText='font-size:11px;color:#888;min-width:64px';lbl.textContent=f.label+':';
    let inp;
    if(f.type==='select'){
      inp=document.createElement('select');inp.style.cssText='flex:1;font-size:12px;padding:2px 4px;border:1px solid #ccc;border-radius:4px';
      (f.options||[]).forEach(o=>{const op=document.createElement('option');op.value=o;op.textContent=o;if(o===f.value)op.selected=true;inp.appendChild(op);});
    }else{
      inp=document.createElement('input');inp.type=f.type||'text';inp.style.cssText='flex:1;font-size:12px;padding:2px 4px;border:1px solid #ccc;border-radius:4px';inp.value=f.value||'';inp.placeholder=f.placeholder||'';
    }
    fieldEls[f.key]=inp;
    row.appendChild(lbl);row.appendChild(inp);rs.appendChild(row);
  });
  const btns=document.createElement('div');btns.style.cssText='display:flex;gap:8px;margin-top:8px';
  const saveBtn=document.createElement('button');saveBtn.textContent='‚úÖ Save';saveBtn.style.cssText='flex:1;padding:6px;background:#003B6F;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:700;font-size:13px';
  const cancelBtn=document.createElement('button');cancelBtn.textContent='‚úï Cancel';cancelBtn.style.cssText='padding:6px 10px;background:#eee;color:#333;border:none;border-radius:6px;cursor:pointer;font-size:13px';
  const retryBtn=document.createElement('button');retryBtn.textContent='üéôÔ∏è Redo';retryBtn.style.cssText='padding:6px 10px;background:#f0f4ff;color:#003B6F;border:1px solid #003B6F;border-radius:6px;cursor:pointer;font-size:13px';
  saveBtn.onclick=()=>{
    if(_saved)return;_saved=true;
    const vals={};fields.forEach(f=>{vals[f.key]=fieldEls[f.key].value;});
    rs.style.display='none';
    setVoiceStatus('Tap üéôÔ∏è to speak again');
    onConfirm(vals);
  };
  cancelBtn.onclick=()=>{rs.style.display='none';setVoiceStatus('Cancelled. Tap üéôÔ∏è to try again.');};
  retryBtn.onclick=()=>{rs.style.display='none';startVoice();};
  btns.appendChild(saveBtn);btns.appendChild(retryBtn);btns.appendChild(cancelBtn);
  rs.appendChild(btns);
  setVoiceStatus('Review & edit below, then Save');
}

function cleanSpeech(raw){
  return raw
    .replace(/\b(um+|uh+|er+|ah+|like|so|well|okay|ok|right|you know|actually|basically|literally)\b[\s,.]*/gi,'')
    .replace(/^(i need (a|an|to)|i want (a|an|to)|i'd like (a|an|to)|can you|could you|please|hey|hi|create me|make me|give me|set up|set me up with|put in|put a|add a|add an|schedule a|schedule me|schedule an|log a|log an|record a|new a|new an)\s+/i,'')
    .replace(/\s{2,}/g,' ').trim();
}

function parseSpokenDate(s){
  if(!s)return null;
  s=s.toLowerCase().trim();
  const today=new Date();
  if(/^today$/.test(s))return TD;
  if(/^tomorrow$/.test(s)){const d=new Date(today);d.setDate(d.getDate()+1);return d.toISOString().slice(0,10);}
  if(/^yesterday$/.test(s)){const d=new Date(today);d.setDate(d.getDate()-1);return d.toISOString().slice(0,10);}
  const DAYS=['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];
  const nd=s.match(/^(?:next\s+)?(sunday|monday|tuesday|wednesday|thursday|friday|saturday)$/);
  if(nd){const target=DAYS.indexOf(nd[1]);const cur=today.getDay();let diff=target-cur;if(diff<=0)diff+=7;const d=new Date(today);d.setDate(d.getDate()+diff);return d.toISOString().slice(0,10);}
  const inD=s.match(/^in\s+(\d+)\s+days?$/);
  if(inD){const d=new Date(today);d.setDate(d.getDate()+parseInt(inD[1]));return d.toISOString().slice(0,10);}
  const MONTHS=['january','february','march','april','may','june','july','august','september','october','november','december'];
  const md=s.match(/^(january|february|march|april|may|june|july|august|september|october|november|december)\s+(\d{1,2})(?:st|nd|rd|th)?$/);
  if(md){const m=MONTHS.indexOf(md[1]);const d=new Date(today.getFullYear(),m,parseInt(md[2]));if(d<today)d.setFullYear(d.getFullYear()+1);return d.toISOString().slice(0,10);}
  const bare=s.match(/^(\d{1,2})[\/\-](\d{1,2})$/);
  if(bare){const d=new Date(today.getFullYear(),parseInt(bare[1])-1,parseInt(bare[2]));if(d<today)d.setFullYear(d.getFullYear()+1);return d.toISOString().slice(0,10);}
  return null;
}
function parseSpokenTime(s){
  if(!s)return'';
  s=s.toLowerCase().trim();
  if(s==='noon')return'12:00';if(s==='midnight')return'00:00';
  const t12=s.match(/^(\d{1,2})(?::(\d{2}))?\s*(am|pm)$/);
  if(t12){let h=parseInt(t12[1]),m=parseInt(t12[2]||0);if(t12[3]==='pm'&&h!==12)h+=12;if(t12[3]==='am'&&h===12)h=0;return String(h).padStart(2,'0')+':'+String(m).padStart(2,'0');}
  const t24=s.match(/^(\d{1,2}):(\d{2})$/);
  if(t24)return String(parseInt(t24[1])).padStart(2,'0')+':'+t24[2];
  const W={one:1,two:2,three:3,four:4,five:5,six:6,seven:7,eight:8,nine:9,ten:10,eleven:11,twelve:12,thirty:30,fifteen:15,forty:40};
  const sp=s.match(/^(one|two|three|four|five|six|seven|eight|nine|ten|eleven|twelve)(?:\s+(thirty|fifteen|forty(?:\s*five)?))?(?:\s+(am|pm))$/);
  if(sp){let h=W[sp[1]]||0,m=sp[2]?(W[sp[2].replace(/\s/,'')]||45):0;if(sp[3]==='pm'&&h!==12)h+=12;if(sp[3]==='am'&&h===12)h=0;return String(h).padStart(2,'0')+':'+String(m).padStart(2,'0');}
  return'';
}
function extractDatetime(raw){
  let date='',time='';
  const dm=raw.match(/\b(?:on\s+|for\s+)?(today|tomorrow|yesterday|next\s+(?:monday|tuesday|wednesday|thursday|friday|saturday|sunday)|monday|tuesday|wednesday|thursday|friday|saturday|sunday|january|february|march|april|may|june|july|august|september|october|november|december\s+\d{1,2}(?:st|nd|rd|th)?|\d{1,2}[\/\-]\d{1,2})\b/i);
  if(dm)date=parseSpokenDate(dm[1])||'';
  const tm=raw.match(/\bat\s+(noon|midnight|\d{1,2}(?::\d{2})?\s*(?:am|pm)|(?:one|two|three|four|five|six|seven|eight|nine|ten|eleven|twelve)(?:\s+(?:thirty|fifteen|forty(?:\s*five)))?\s*(?:am|pm))/i);
  if(tm)time=parseSpokenTime(tm[1])||'';
  return{date,time};
}
function stripDatetime(s){
  return s
    .replace(/\b(?:on\s+|for\s+)?(?:today|tomorrow|yesterday|next\s+(?:monday|tuesday|wednesday|thursday|friday|saturday|sunday)|monday|tuesday|wednesday|thursday|friday|saturday|sunday|january|february|march|april|may|june|july|august|september|october|november|december\s+\d{1,2}(?:st|nd|rd|th)?)\b/gi,'')
    .replace(/\bat\s+(?:noon|midnight|\d{1,2}(?::\d{2})?\s*(?:am|pm)?)/gi,'')
    .replace(/\s{2,}/g,' ').trim().replace(/[,.]$/,'').trim();
}
function inferBucket(s){
  const t=s.toLowerCase();
  if(/\b(clo|work|office|federal|government|team|staff|leadership|cindy|maxiflex)\b/.test(t))return'CLO Work';
  if(/\b(way forged|wayforged|business|client|invoice|contract)\b/.test(t))return'Way Forged LLC';
  if(/\b(blacksmith|forge|anvil|weld|iron|smith)\b/.test(t))return'Blacksmith';
  if(/\b(row|rowing|erg|paddle|boat|regatta|race)\b/.test(t))return'Row & Throw';
  if(/\b(throw|throwing|highland|hammer|caber|stone|games|athletics|workout|lift|run|swim|walk)\b/.test(t))return'Athletics';
  if(/\b(wilbur|simba|pet|dog|cat|vet|puppy|kitten|training|treat)\b/.test(t))return'Pets';
  if(/\b(home|house|yard|garage|kitchen|repair|maintenance|bill|grocery|groceries)\b/.test(t))return'Home';
  if(/\b(learn|study|journal|book|article|class|course|read|language)\b/.test(t))return'Learning';
  return'Personal';
}
function detectIntent(t){
  if(/\b(calendar|event|invite|meeting|appointment|appt|schedule|on my calendar)\b/.test(t))return'event';
  if(/\b(remind|reminder|don't forget|make sure i|alert)\b/.test(t))return'reminder';
  if(/\b(grocery|groceries|shopping list|shopping|store|pick up|need to (buy|get)|buy some|get some)\b/.test(t))return'grocery';
  if(/\b(journal|diary|story|reflect|wrote|feeling|thoughts|log (that|how)|note (that|how))\b/.test(t))return'journal';
  if(/\b(workout|exercise|ran|run|lift|swim|row|erg|walked|yoga|hiit)\b/.test(t))return'workout';
  if(/\b(meal|ate|eating|food|breakfast|lunch|dinner|snack|calories|protein)\b/.test(t))return'meal';
  if(/\b(fix|repair|maintenance|broken|replace|install|clean)\b/.test(t))return'maintenance';
  if(/\b(morning (checklist|routine|check))\b/.test(t))return'morning';
  if(/\b(evening (checklist|routine|check))\b/.test(t))return'evening';
  if(/\b(go to|open|show|take me to|navigate)\b/.test(t))return'navigate';
  if(/\b(task|todo|to.do|to do|don't forget to|need to|have to|must)\b/.test(t))return'task';
  return'task';
}
function extractTitle(clean,intent){
  let s=clean;
  const removes={
    event:[/\b(calendar (invite|event)?|event|invite|meeting|appointment|appt|on (the |my )?calendar)\b/gi],
    task:[/\b(task|to.?do|need to|have to|must|don'?t forget to)\b/gi],
    reminder:[/\b(remind(er)?|don'?t forget|make sure i|alert)\b/gi],
    grocery:[/\b(grocery|groceries|shopping (list)?|pick up|buy|get)\b/gi],
    journal:[/\b(journal (entry)?|diary|story|log that|note that|reflect(ion)?)\b/gi],
    workout:[/\b(log(ged)?|record(ed)?|workout|exercise|did a|went for (a )?)\b/gi],
    meal:[/\b(log(ged)?|ate|eating|had|meal|food)\b/gi],
    maintenance:[/\b(fix|repair|maintenance|need to|have to)\b/gi],
    morning:[/\b(morning (checklist|routine|check)|add to morning)\b/gi],
    evening:[/\b(evening (checklist|routine|check)|add to evening)\b/gi],
  };
  (removes[intent]||[]).forEach(re=>s=s.replace(re,''));
  s=s.replace(/\b(under|in the?|for the?|to the?|into the?)\s+(pets?|home|work|clo|athletics|blacksmith|learning|personal|way forged|grocery|calendar|training|rowing|throwing)\s*(section|tab|area|category)?\b/gi,'');
  s=stripDatetime(s);
  return s.replace(/\s{2,}/g,' ').trim().replace(/^[,.\-‚Äì]\s*/,'').trim();
}

function processVoiceCommand(rawInput){
  const raw=rawInput.trim();
  const cleaned=cleanSpeech(raw);
  const t=cleaned.toLowerCase();
  const{date:spokenDate,time:spokenTime}=extractDatetime(raw);
  const bucket=inferBucket(raw);
  const intent=detectIntent(t);

  const navMap={today:"today",tasks:"today",calendar:"today",work:"work",clo:"work","way forged":"work",life:"life",grocery:"life",pets:"life",budget:"life",home:"life",shehulk:"shehulk","she hulk":"shehulk",rowing:"shehulk",throwing:"shehulk",athletics:"shehulk",mind:"mind",learning:"mind",journal:"mind",stories:"mind",blacksmith:"blacksmith",settings:"settings"};
  if(intent==='navigate'){
    const nm=t.match(/(?:go to|open|show|take me to|navigate(?:\s+to)?)\s+(.+)/i);
    if(nm){const dest=nm[1].trim().toLowerCase().replace(/\s+/g,' ');const tab=navMap[dest]||navMap[Object.keys(navMap).find(k=>dest.includes(k))||''];if(tab){S.tab=tab;sv();R();showVoiceResult('‚úÖ Navigated to '+nm[1]);return;}}
  }

  const paidMatch=raw.match(/\b(?:mark|set)\s+(.+?)\s+(?:as\s+)?paid\b/i)||raw.match(/\bpay(?:ed|ing)?\s+(?:the\s+)?(.+?)\s+bill\b/i);
  if(paidMatch){const bname=paidMatch[1].trim().toLowerCase();const bill=(S.bills||[]).find(b=>b.n.toLowerCase().includes(bname));if(bill){bill.paid=1;sv();R();showVoiceResult('‚úÖ Marked as paid: '+bill.n);return;}else{showVoiceResult('‚ùå Bill not found matching "'+paidMatch[1]+'". Check spelling.',false);return;}}

  if(intent==='event'){
    const title=extractTitle(cleaned,'event')||'New Event';
    const petMatch=raw.match(/\bfor\s+(wilbur|simba)\b/i);
    const finalBucket=petMatch?'Pets':bucket;
    voiceConfirm('Add Calendar Event',[
      {key:'title',label:'Title',value:title},
      {key:'date',label:'Date',type:'date',value:spokenDate||TD},
      {key:'time',label:'Time',type:'time',value:spokenTime},
      {key:'bucket',label:'Section',type:'select',options:BK,value:finalBucket},
    ],(vals)=>{S.calEv.push({id:uid(),title:vals.title,date:vals.date,time:vals.time,endTime:"",bucket:vals.bucket,notes:""});sv();R();showVoiceResult('‚úÖ Event added: "'+vals.title+'"');});
    return;
  }
  if(intent==='reminder'){
    const title=extractTitle(cleaned,'reminder')||'Reminder';
    voiceConfirm('Add Reminder',[
      {key:'text',label:'Reminder',value:title},
      {key:'date',label:'Date',type:'date',value:spokenDate||TD},
    ],(vals)=>{S.rem.push({id:uid(),text:vals.text,date:vals.date,created:TD});sv();R();showVoiceResult('‚úÖ Reminder added: "'+vals.text+'"');});
    return;
  }
  if(intent==='grocery'){
    const item=extractTitle(cleaned,'grocery')||cleaned;
    voiceConfirm('Add to Grocery List',[{key:'text',label:'Item',value:item}],(vals)=>{S.gM.push({id:uid(),text:vals.text,ck:0});sv();R();showVoiceResult('‚úÖ Added to grocery list: "'+vals.text+'"');});
    return;
  }
  if(intent==='journal'){
    const content=extractTitle(cleaned,'journal')||cleaned;
    voiceConfirm('Add Journal Entry',[
      {key:'content',label:'Entry',value:content},
      {key:'bucket',label:'Section',type:'select',options:BK,value:bucket},
      {key:'mood',label:'Mood/tag',value:'',placeholder:'optional'},
    ],(vals)=>{S.jour.unshift({id:uid(),title:"",content:vals.content,bucket:vals.bucket,mood:vals.mood,refDate:"",date:TD,created:TD});sv();R();showVoiceResult('‚úÖ Journal entry saved.');});
    return;
  }
  if(intent==='workout'){
    const wtMatch=cleaned.match(/\b(walk(?:ed)?|run(?:ning)?|ran|swim(?:ming)?|lift(?:ing)?|erg(?:ging)?|row(?:ing)?|throw(?:ing)?|yoga|hiit|other)\b/i);
    const durMatch=cleaned.match(/\b(\d+)\s*(min(?:utes?)?|mi(?:les?)?|hours?|hrs?)\b/i);
    const wtype=wtMatch?WT.find(x=>x.toLowerCase().startsWith(wtMatch[1].toLowerCase().slice(0,3)))||wtMatch[1]:'Other';
    const dur=durMatch?durMatch[1]:'';
    const unit=durMatch&&durMatch[2].toLowerCase().startsWith('mi')&&!durMatch[2].toLowerCase().startsWith('min')?'mi':'min';
    voiceConfirm('Log Workout',[
      {key:'type',label:'Type',type:'select',options:WT,value:wtype},
      {key:'dur',label:'Duration',value:dur,placeholder:'e.g. 30'},
      {key:'unit',label:'Unit',type:'select',options:['min','mi'],value:unit},
      {key:'date',label:'Date',type:'date',value:spokenDate||TD},
    ],(vals)=>{S.wk.unshift({id:uid(),type:vals.type,dur:vals.dur,unit:vals.unit,notes:"",date:vals.date,created:TD});sv();R();showVoiceResult('‚úÖ Workout logged: '+vals.type+(vals.dur?' ¬∑ '+vals.dur+vals.unit:''));});
    return;
  }
  if(intent==='meal'){
    const calM=cleaned.match(/\b(\d+)\s*(?:cal(?:ories?)?)\b/i);
    const proM=cleaned.match(/\b(\d+)\s*g?\s*(?:protein|pro)\b/i);
    const mname=extractTitle(cleaned,'meal')||cleaned;
    voiceConfirm('Log Meal',[
      {key:'name',label:'Meal',value:mname},
      {key:'cal',label:'Calories',value:calM?calM[1]:'',placeholder:'e.g. 400'},
      {key:'pro',label:'Protein g',value:proM?proM[1]:'',placeholder:'e.g. 30'},
    ],(vals)=>{S.meals.unshift({id:uid(),name:vals.name,cal:vals.cal,pro:vals.pro,carbs:"",fat:"",date:TD,created:TD});sv();R();showVoiceResult('‚úÖ Meal logged: '+vals.name+(vals.cal?' ¬∑ '+vals.cal+' cal':''));});
    return;
  }
  if(intent==='maintenance'){
    const task=extractTitle(cleaned,'maintenance')||cleaned;
    voiceConfirm('Add Maintenance Task',[{key:'task',label:'Task',value:task}],(vals)=>{S.maint.push({id:uid(),task:vals.task,status:"Not Started",date:TD});sv();R();showVoiceResult('‚úÖ Maintenance task added: "'+vals.task+'"');});
    return;
  }
  if(intent==='morning'){
    const item=extractTitle(cleaned,'morning')||cleaned;
    voiceConfirm('Add to Morning Checklist',[{key:'text',label:'Item',value:item}],(vals)=>{if(!S.morningCk)S.morningCk=[];S.morningCk.push({id:uid(),text:vals.text,done:0});sv();R();showVoiceResult('‚úÖ Added: "'+vals.text+'"');});
    return;
  }
  if(intent==='evening'){
    const item=extractTitle(cleaned,'evening')||cleaned;
    voiceConfirm('Add to Evening Checklist',[{key:'text',label:'Item',value:item}],(vals)=>{if(!S.eveningCk)S.eveningCk=[];S.eveningCk.push({id:uid(),text:vals.text,done:0});sv();R();showVoiceResult('‚úÖ Added: "'+vals.text+'"');});
    return;
  }

  const prioM=t.match(/\b(high|urgent|important|critical)\b/i)?'High':t.match(/\b(low|minor|eventually|someday)\b/i)?'Low':'Medium';
  const title=extractTitle(cleaned,'task')||cleaned;
  voiceConfirm('Add Task',[
    {key:'title',label:'Title',value:title},
    {key:'priority',label:'Priority',type:'select',options:PR,value:prioM},
    {key:'bucket',label:'Section',type:'select',options:BK,value:bucket},
    {key:'dueDate',label:'Due Date',type:'date',value:spokenDate},
    {key:'startTime',label:'Time',type:'time',value:spokenTime},
  ],(vals)=>{
    S.tasks.push({id:uid(),title:vals.title,priority:vals.priority,bucket:vals.bucket,stage:"Not Started",completed:0,createdDate:TD,dueDate:vals.dueDate||null,startTime:vals.startTime||"",notes:""});
    sv();R();showVoiceResult('‚úÖ Task added: "'+vals.title+'"');
  });
}

function showVoiceHelp(){ml('üéôÔ∏è Voice Commands',`<div style="font-size:13px;line-height:1.8">
<b>Just talk naturally ‚Äì no magic words needed!</b><br>
Filler words like "um", "uh", "I need a" are ignored.<br><br>
<b>Examples:</b><br>
"um I need a calendar invite for Wilbur's vet on Monday at 2pm"<br>
"add task call the doctor on Friday"<br>
"I need to pick up eggs and milk"<br>
"remind me to take my medication tomorrow"<br>
"log workout run 30 minutes"<br>
"I ate chicken salad for lunch, about 400 calories"<br>
"journal entry I had a great training session today"<br>
"fix the porch light"<br>
"mark electric as paid"<br>
"open grocery" / "go to calendar"<br><br>
<b>Date/time phrases:</b><br>
"on Monday", "tomorrow", "next Friday"<br>
"on March 15", "at 3pm", "at noon"<br><br>
<b>App sections auto-detected from keywords:</b><br>
Wilbur/Simba ‚Üí Pets ¬∑ CLO/work/team ‚Üí CLO Work<br>
rowing/erg ‚Üí Row & Throw ¬∑ forge/anvil ‚Üí Blacksmith<br>
</div>`);}

// ‚îÄ‚îÄ Core helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function h(t,a,c){
  const e=document.createElement(t);
  if(a)for(const[k,v]of Object.entries(a)){
    if(v==null)continue;
    if(k==="style"&&typeof v==="object")Object.assign(e.style,v);
    else if(k[0]==="o"&&k[1]==="n")e[k.toLowerCase()]=v;
    else if(k==="class")e.className=v;
    else if(k==="checked")e.checked=!!v;
    else e.setAttribute(k,String(v));
  }
  if(c)for(const x of c){
    if(x==null||x===false||x===undefined)continue;
    if(typeof x==="string"||typeof x==="number"){e.appendChild(document.createTextNode(String(x)));}
    else if(x instanceof Node){e.appendChild(x);}
  }
  return e;
}
async function ld(){for(const k of KS){const v=await st.get("t5_"+k);if(v!==null)S[k]=v;}if(!S.cloCats)S.cloCats=JSON.parse(JSON.stringify(DCLO));S.cloCats.forEach(c=>{if(!c.subs)c.subs=[];});if(!S.acr)S.acr=ACRS.map(s=>({id:uid(),s,t:[],n:[]}));if(!S.swk)S.swk=[];if(!S.houseCk)S.houseCk=JSON.parse(JSON.stringify(DFLT_HCK));if(!S.homeLinks)S.homeLinks=[];if(!S.morningCk)S.morningCk=[];if(!S.eveningCk)S.eveningCk=[];if(!S.cloLinks)S.cloLinks=[];if(!S.wfLinks)S.wfLinks=[];if(!S.rowLinks)S.rowLinks=[];if(!S.throwLinks)S.throwLinks=[];if(!S.bsLinks)S.bsLinks=[];if(!S.learnLinks)S.learnLinks=[];if(!S.petLinks)S.petLinks=[];if(!S.jour)S.jour=[];if(!S.lP)S.lP=[];if(!S.bsP)S.bsP=[];if(!S.wfP)S.wfP=[];const cm=TD.slice(0,7);if(S.lastBillReset!==cm){S.bills.forEach(b=>{if(b.recurrence==="Monthly")b.paid=0;});S.lastBillReset=cm;sv();}const today=new Date();if(today.getDate()===1){S.bills.forEach(b=>{if(b.recurrence==="Monthly")b.paid=0;});sv();}}
function sv(){KS.forEach(k=>st.set("t5_"+k,S[k]));}
function R(){const r=document.getElementById("root");r.innerHTML="";try{r.appendChild(S.unlocked?rApp():rLock());}catch(err){console.error("Render error:",err);r.innerHTML='<div style="padding:20px;color:#c0392b;font-family:sans-serif"><b>Render error:</b><br>'+err.message+'<br><small>Check the console for details.</small></div>';}}
function $(l,f,c="B Bp",s={}){const x=h("button",{class:c,onclick:f,style:s});x.innerHTML=l;return x;}
function ip(t,v,f,p=""){const i=h("input",{type:t,value:v||"",placeholder:p});i.oninput=e=>f(e.target.value);return i;}
function sl(v,f,o){const s=h("select");o.forEach(i=>{const vl=i.value!==undefined?i.value:i;const op=h("option",{value:vl},[i.label||i]);if(vl===v)op.selected=true;s.appendChild(op);});s.onchange=e=>f(e.target.value);return s;}
function ta(v,f,p,r=3){const t=h("textarea",{placeholder:p,rows:r});t.value=v||"";t.oninput=e=>f(e.target.value);return t;}
function bg(l,c=P){return h("span",{class:"badge",style:{background:c}},[String(l||"")]);}
function C(c,s={}){return h("div",{class:"C",style:s},c);}
function H(t,a=[]){return h("div",{class:"H"},[h("h3",{},[t]),h("div",{class:"Ha"},a)]);}
function ml(t,c){const o=h("div",{class:"M"});const b=h("div",{class:"Mb"});b.appendChild(h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"12px"}},[h("strong",{style:{fontSize:"18px",color:P}},[t]),$("‚úï",()=>o.remove(),"",{background:"none",border:"none",fontSize:"20px",cursor:"pointer",color:"#333"})]));b.appendChild(c instanceof HTMLElement?c:Object.assign(h("div"),{innerHTML:c}));o.appendChild(b);document.body.appendChild(o);return o;}
function FL(l,i){return h("div",{},[h("label",{class:"fl"},[l]),i]);}
function lr(l,u){return h("a",{href:u,target:"_blank",style:{display:"block",padding:"7px 0",color:P,textDecoration:"none",borderBottom:"1px solid #eee",fontSize:"14px"}},["üîó "+l]);}
function SB(ts,a,f){return h("div",{class:"S"},ts.map(([k,l])=>$(l,()=>f(k),"Si"+(a===k?" a":""))));}
function PB(p,c="#2980b9"){return h("div",{class:"pb"},[h("div",{class:"pf",style:{background:c,width:Math.min(p,100)+"%"}})]);}
function CK(ck,f){const c=h("input",{type:"checkbox"});c.checked=!!ck;c.onchange=f;return c;}
function DL(f){return $("üóë",f,"",{background:"none",border:"none",color:"#e74c3c",cursor:"pointer",fontSize:"14px"});}
function AI(ph,fn){const i=ip("text","",()=>{},ph);let _busy=false;const go=()=>{if(_busy||!i.value.trim())return;_busy=true;fn(i.value.trim());i.value='';R();};i.addEventListener("keydown",e=>{if(e.key==="Enter")go();});return h("div",{style:{display:"flex",gap:"6px",marginTop:"8px",width:"100%"}},[i,$("+",go,"Bs Bp")]);}
function ED(txt,onSave){const sp=h("span",{class:"editable",style:{flex:"1",fontSize:"13px"}},[txt]);sp.onclick=()=>{const inp=h("input",{type:"text",value:txt,style:{flex:"1",fontSize:"13px",border:"1px solid #003B6F",borderRadius:"4px",padding:"4px"}});inp.onblur=()=>{if(inp.value.trim()&&inp.value!==txt){onSave(inp.value.trim());}else{sp.textContent=txt;inp.replaceWith(sp);}};inp.onkeydown=e=>{if(e.key==="Enter"){inp.blur();}else if(e.key==="Escape"){sp.textContent=txt;inp.replaceWith(sp);}};sp.replaceWith(inp);inp.focus();inp.select();};return sp;}
function gearL(w,g,set,lb){const c=C([]);c.appendChild(h("div",{style:{fontWeight:"700",marginBottom:"8px"}},[lb]));(g||[]).forEach((it,i)=>{c.appendChild(h("div",{style:{display:"flex",alignItems:"center",gap:"6px",padding:"5px 0",borderBottom:"1px solid #eee",width:"100%"}},[h("span",{style:{flex:"1",fontSize:"13px"}},[it]),$("‚úèÔ∏è",()=>{const v=prompt("Edit:",it);if(v!=null){const a=[...g];a[i]=v;set(a);sv();R();}},"",{background:"none",border:"none",cursor:"pointer",color:P,fontSize:"12px"}),DL(()=>{set(g.filter((_,j)=>j!==i));sv();R();})]));});c.appendChild(AI("Add item...",v=>{set([...g,v]);sv();}));w.appendChild(c);}
function linksSec(w,linksKey,title){if(!S[linksKey])S[linksKey]=[];const links=S[linksKey];const c=C([]);c.appendChild(h("div",{style:{fontWeight:"700",marginBottom:"8px"}},[title]));if(!links.length){c.appendChild(h("div",{style:{color:"#aaa",textAlign:"center",padding:"16px"}},["No custom links yet."]));}else{links.forEach(l=>{const linkDiv=h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"8px 0",borderBottom:"1px solid #eee",width:"100%"}});const anchor=h("a",{href:l.url,target:"_blank",rel:"noopener noreferrer",style:{flex:"1",color:P,textDecoration:"none",fontSize:"14px",cursor:"pointer"}});anchor.textContent="üîó "+l.name;anchor.onclick=e=>{e.preventDefault();let url=l.url;if(!url.startsWith("http://")&&!url.startsWith("https://"))url="https://"+url;window.open(url,"_blank");};linkDiv.appendChild(anchor);linkDiv.appendChild(DL(()=>{S[linksKey]=S[linksKey].filter(x=>x.id!==l.id);sv();R();}));c.appendChild(linkDiv);});}c.appendChild($("+ Link",()=>{const f={n:"",u:""};const m=ml("Add Link",h("div",{style:{display:"flex",flexDirection:"column",gap:"10px"}},[ip("text","",v=>f.n=v,"Link Name"),ip("text","",v=>f.u=v,"URL (e.g., https://example.com)"),$("Add",()=>{if(!f.n.trim()||!f.u.trim())return;let url=f.u.trim();if(!url.startsWith("http://")&&!url.startsWith("https://"))url="https://"+url;S[linksKey].push({id:uid(),name:f.n.trim(),url});sv();m.remove();R();},"B Bp")]));},"Bs Bp",{marginTop:"8px"}));w.appendChild(c);}
function acrV(w,projects){(projects||[]).forEach(p=>{const op=S.u.ae[p.id];const c=C([],{borderLeft:"4px solid "+GL});c.appendChild(h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",cursor:"pointer",width:"100%"},onclick:()=>{S.u.ae[p.id]=!op;R();}},[h("div",{},[h("div",{style:{fontWeight:"700"}},[p.s||""]),h("div",{style:{fontSize:"12px",color:"#666"}},[(p.t||[]).length+" tasks"])]),h("span",{style:{fontSize:"16px"}},[op?"‚ñ≤":"‚ñº"])]));if(op){const bd=h("div",{style:{marginTop:"10px",width:"100%"}});(p.t||[]).forEach(t=>{const taskDiv=h("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto auto",gap:"8px",alignItems:"center",padding:"6px 0",borderBottom:"1px solid #eee",width:"100%"}});taskDiv.appendChild(CK(t.done,()=>{t.done=!t.done;sv();R();}));const contentDiv=h("div",{style:{flex:"1"}});contentDiv.appendChild(ED(t.title||"Untitled",v=>{t.title=v;t.lastEdited=TD;sv();R();}));if(t.dueDate)contentDiv.appendChild(h("div",{style:{fontSize:"10px",color:"#888",marginTop:"2px"}},["üìÖ "+fmt(t.dueDate)]));if(t.refDate)contentDiv.appendChild(h("div",{style:{fontSize:"10px",color:"#666",marginTop:"2px"}},["üìù "+t.refDate]));taskDiv.appendChild(contentDiv);taskDiv.appendChild($("‚úèÔ∏è",()=>{const tf={title:t.title||"Untitled",dueDate:t.dueDate||"",refDate:t.refDate||""};const tm=ml("Edit Task",h("div",{style:{display:"flex",flexDirection:"column",gap:"8px"}},[ip("text",t.title,v=>tf.title=v,"Task"),ip("date",t.dueDate||"",v=>tf.dueDate=v,"Due Date"),ip("text",t.refDate||"",v=>tf.refDate=v,"Reference Date"),$("Save",()=>{t.title=tf.title.trim();t.dueDate=tf.dueDate||null;t.refDate=tf.refDate||null;t.lastEdited=TD;sv();tm.remove();R();},"B Bp")]));},"",{background:"none",border:"none",cursor:"pointer",color:P,fontSize:"12px"}));taskDiv.appendChild(DL(()=>{p.t=p.t.filter(x=>x.id!==t.id);sv();R();}));bd.appendChild(taskDiv);});bd.appendChild(AI("Add task...",v=>{if(!p.t)p.t=[];p.t.push({id:uid(),title:v,done:0,dueDate:null,refDate:null});sv();}));bd.appendChild(h("div",{style:{fontWeight:"600",fontSize:"13px",margin:"10px 0 4px"}},["Notes"]));(p.n||[]).forEach(n=>{const noteDiv=h("div",{style:{background:"#f9f9f9",borderRadius:"6px",padding:"6px",marginBottom:"4px",fontSize:"12px",display:"flex",justifyContent:"space-between",alignItems:"start",gap:"6px"}});noteDiv.appendChild(h("span",{style:{flex:"1"}},[fmt(n.d)+" ‚Äì "+(n.t||"")]));noteDiv.appendChild($("‚úèÔ∏è",()=>{const nt=prompt("Edit note:",n.t);if(nt!==null&&nt.trim()){n.t=nt.trim();n.lastEdited=TD;sv();R();}},"",{background:"none",border:"none",cursor:"pointer",color:P,fontSize:"11px"}));noteDiv.appendChild(DL(()=>{p.n=p.n.filter(x=>x.id!==n.id);sv();R();}));bd.appendChild(noteDiv);});bd.appendChild(AI("Add note...",v=>{if(!p.n)p.n=[];p.n.push({id:uid(),t:v,d:TD});sv();}));c.appendChild(bd);}w.appendChild(c);});}
function getAllTasks(){const all=[];(S.tasks||[]).forEach(t=>all.push(t));(S.cloCats||[]).forEach(c=>{(c.tasks||[]).forEach(t=>all.push({...t,bucket:"CLO Work"}));(c.subs||[]).forEach(s=>(s.tasks||[]).forEach(t=>all.push({...t,bucket:"CLO Work",completed:t.done})));});(S.wfP||[]).forEach(p=>(p.tasks||[]).forEach(t=>all.push({...t,bucket:"Way Forged LLC"})));(S.acr||[]).forEach(a=>(a.t||[]).forEach(t=>all.push({...t,bucket:"Athletics",title:t.title,completed:t.done})));(S.pets||[]).forEach(p=>(p.tr||[]).forEach(t=>all.push({...t,bucket:"Pets",title:t.text,completed:t.done})));(S.maint||[]).forEach(m=>all.push({...m,bucket:"Home",title:m.task,completed:m.status==="Complete"}));(S.lP||[]).forEach(p=>all.push({...p,bucket:"Learning",completed:p.stage==="Complete"}));(S.bsP||[]).forEach(p=>all.push({...p,bucket:"Blacksmith",title:p.name,completed:p.stage==="Complete"}));return all;}
function getAllCalEv(){const all=[];all.push(...(S.calEv||[]));all.push(...(S.icsEv||[]));(S.tasks||[]).forEach(t=>{if(t.dueDate)all.push({id:t.id,title:t.title,date:t.dueDate,time:t.startTime||"",bucket:t.bucket||"Personal",source:"task",ref:t});});(S.rec||[]).forEach(r=>{const today=new Date();const recDate=new Date(r.createdDate+"T00:00:00");if(r.recurrence==="Daily"){for(let d=new Date(recDate);d<=new Date(today.getFullYear(),today.getMonth()+2,0);d.setDate(d.getDate()+1)){const ds=d.toISOString().slice(0,10);all.push({id:r.id+"_"+ds,title:r.title,date:ds,time:r.startTime||"",bucket:r.bucket||"Personal",source:"recurring_task",ref:r});}}else if(r.recurrence==="Weekdays"){for(let d=new Date(recDate);d<=new Date(today.getFullYear(),today.getMonth()+2,0);d.setDate(d.getDate()+1)){if(d.getDay()>=1&&d.getDay()<=5){const ds=d.toISOString().slice(0,10);all.push({id:r.id+"_"+ds,title:r.title,date:ds,time:r.startTime||"",bucket:r.bucket||"Personal",source:"recurring_task",ref:r});}}}else if(r.recurrence==="Weekly"){const dayOfWeek=recDate.getDay();for(let d=new Date(recDate);d<=new Date(today.getFullYear(),today.getMonth()+2,0);d.setDate(d.getDate()+1)){if(d.getDay()===dayOfWeek){const ds=d.toISOString().slice(0,10);all.push({id:r.id+"_"+ds,title:r.title,date:ds,time:r.startTime||"",bucket:r.bucket||"Personal",source:"recurring_task",ref:r});}}}else if(r.recurrence==="Monthly"){const dayOfMonth=recDate.getDate();for(let m=0;m<=3;m++){const targetDate=new Date(today.getFullYear(),today.getMonth()+m,dayOfMonth);if(!isNaN(targetDate.getTime())){const ds=targetDate.toISOString().slice(0,10);all.push({id:r.id+"_"+ds,title:r.title,date:ds,time:r.startTime||"",bucket:r.bucket||"Personal",source:"recurring_task",ref:r});}}}});(S.cloCats||[]).forEach(c=>{(c.tasks||[]).forEach(t=>{if(t.dueDate)all.push({id:t.id,title:t.title,date:t.dueDate,time:t.startTime||"",bucket:"CLO Work",source:"task",ref:t});});(c.subs||[]).forEach(s=>(s.tasks||[]).forEach(t=>{if(t.dueDate)all.push({id:t.id,title:t.title,date:t.dueDate,time:"",bucket:"CLO Work",source:"task",ref:t});}));});(S.wfP||[]).forEach(p=>{if(p.dueDate)all.push({id:p.id,title:p.title,date:p.dueDate,time:"",bucket:"Way Forged LLC",source:"wf_project",ref:p});(p.tasks||[]).forEach(t=>{if(t.dueDate)all.push({id:t.id,title:t.title,date:t.dueDate,time:"",bucket:"Way Forged LLC",source:"task",ref:t});});});(S.acr||[]).forEach(a=>(a.t||[]).forEach(t=>{if(t.dueDate)all.push({id:t.id,title:t.title,date:t.dueDate,time:"",bucket:"Athletics",source:"acr_task",ref:t});}));(S.pets||[]).forEach(p=>(p.ap||[]).forEach(a=>all.push({id:a.id,title:p.name+" Appt"+(a.note?" - "+a.note:""),date:a.date,time:"",bucket:"Pets",source:"pet_appt",ref:a})));(S.maint||[]).forEach(m=>{if(m.date)all.push({id:m.id,title:m.task,date:m.date,time:"",bucket:"Home",source:"maint",ref:m});});(S.lP||[]).forEach(p=>{if(p.dueDate)all.push({id:p.id,title:p.title,date:p.dueDate,time:"",bucket:"Learning",source:"learning",ref:p});});(S.bsP||[]).forEach(p=>{(p.tasks||[]).forEach(t=>{if(t.dueDate)all.push({id:t.id,title:t.title,date:t.dueDate,time:"",bucket:"Blacksmith",source:"bs_task",ref:t});});});(S.bills||[]).forEach(b=>{if(b.recurrence==="One-time"&&b.date){all.push({id:b.id,title:b.n+" - $"+b.a,date:b.date,time:"",bucket:"Home",source:"bill",ref:b});}else if(b.recurrence==="Monthly"){const today=new Date();for(let m=0;m<=3;m++){const targetDate=new Date(today.getFullYear(),today.getMonth()+m,b.day);if(!isNaN(targetDate.getTime())){const ds=targetDate.toISOString().slice(0,10);all.push({id:b.id+"_"+ds,title:b.n+" - $"+b.a,date:ds,time:"",bucket:"Home",source:"bill",ref:b});}}}});(S.rem||[]).forEach(r=>{if(r.date)all.push({id:r.id,title:r.text,date:r.date,time:"",bucket:"Home",source:"reminder",ref:r});});(S.swk||[]).forEach(w=>all.push({id:w.id,title:w.type+(w.dur?" "+w.dur+(w.unit==="mi"?"mi":"m"):""),date:w.date,time:w.time||"",bucket:"Athletics",source:"workout",ref:w}));return all;}

// ‚îÄ‚îÄ Lock screen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function rLock(){
  const w=h("div",{style:{minHeight:"100vh",background:P,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:"24px"}});
  const bx=h("div",{style:{background:"#fff",borderRadius:"16px",padding:"28px",width:"100%",maxWidth:"360px"}});
  if(S.pw){
    const pi=ip("password","",()=>{},"Password");
    const er=h("div",{style:{color:"#e74c3c",fontSize:"12px",marginTop:"6px"}});
    let _busy=false;
    const ub=$("Unlock",async()=>{
      if(_busy)return;_busy=true;
      er.textContent="Checking‚Ä¶";
      const h256=await hashPw(pi.value);
      if(h256===S.pw){S.unlocked=1;S._sessionPw=pi.value;R();}
      else{er.textContent="Wrong password.";_busy=false;}
    },"B Bp",{marginTop:"12px",width:"100%"});
    pi.addEventListener("keydown",e=>{if(e.key==="Enter")ub.click();});
    bx.appendChild(h("div",{style:{fontWeight:"700",fontSize:"18px",color:P,marginBottom:"16px",textAlign:"center"}},["üîí Enter Password"]));
    bx.appendChild(pi);bx.appendChild(er);bx.appendChild(ub);
    bx.appendChild($("Change Password",()=>pwM(),"",{display:"block",margin:"10px auto 0",background:"none",border:"none",color:"#888",fontSize:"12px",cursor:"pointer"}));
  }else{
    bx.appendChild(h("div",{style:{fontWeight:"700",fontSize:"18px",color:P,marginBottom:"16px",textAlign:"center"}},["Welcome!"]));
    bx.appendChild($("Set Password",()=>pwM(),"B Bp",{width:"100%"}));
    bx.appendChild($("Skip (no lock)",()=>{S.unlocked=1;R();},"",{display:"block",margin:"10px auto 0",background:"none",border:"none",color:"#888",fontSize:"13px",cursor:"pointer",width:"100%"}));
  }
  const tardisIcon=h("div",{style:{width:"120px",height:"140px",marginBottom:"16px"}});
  tardisIcon.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><linearGradient id="bg2" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:#2d4c65"/><stop offset="100%" style="stop-color:#1a3548"/></linearGradient></defs><rect x="45" y="5" width="10" height="4" fill="#2850a0" stroke="#000" stroke-width="0.5"/><rect x="47.5" y="3" width="5" height="2" fill="#ffcc00"/><rect x="35" y="9.5" width="30" height="7" fill="#001533"/><text x="50" y="14.5" font-family="Arial,sans-serif" font-size="5" font-weight="bold" fill="#fff" text-anchor="middle">POLICE BOX</text><rect x="30" y="16.5" width="40" height="70" fill="url(#bg2)" stroke="#000" stroke-width="1.5"/><rect x="34" y="21" width="8" height="9" fill="#ddeeff" stroke="#000" stroke-width="0.8"/><rect x="45" y="21" width="8" height="9" fill="#ddeeff" stroke="#000" stroke-width="0.8"/><rect x="56" y="21" width="8" height="9" fill="#ddeeff" stroke="#000" stroke-width="0.8"/><rect x="34" y="33" width="8" height="9" fill="#ddeeff" stroke="#000" stroke-width="0.8"/><rect x="45" y="33" width="8" height="9" fill="#ddeeff" stroke="#000" stroke-width="0.8"/><rect x="56" y="33" width="8" height="9" fill="#ddeeff" stroke="#000" stroke-width="0.8"/><rect x="40" y="50" width="20" height="28" fill="#8a8a75" stroke="#000" stroke-width="1"/><rect x="42" y="52" width="7" height="24" fill="#707060" stroke="#000" stroke-width="0.5"/><rect x="51" y="52" width="7" height="24" fill="#707060" stroke="#000" stroke-width="0.5"/><rect x="30" y="80.5" width="40" height="6" fill="#000"/></svg>';
  w.appendChild(tardisIcon);
  w.appendChild(h("div",{style:{fontSize:"26px",fontWeight:"900",color:"#fff",marginBottom:"4px"}},["Dr. Way's T.A.R.D.I.S."]));
  const su=h("div",{style:{fontSize:"12px",color:"#aec8e8",fontStyle:"italic",marginBottom:"32px",textAlign:"center"}});
  su.innerHTML='"I always take you where you need to go."';
  w.appendChild(su);w.appendChild(bx);return w;
}

function pwM(requireOld=!!S.pw){
  const f={old:"",a:"",b:""};
  const er=h("div",{style:{color:"#e74c3c",fontSize:"12px"}});
  const oldRow=requireOld?FL("Current Password",ip("password","",v=>f.old=v,"Current password")):null;
  const p1=ip("password","",v=>f.a=v,"New password (min 6)");
  const p2=ip("password","",v=>f.b=v,"Confirm new password");
  let _busy=false;
  const s=$("Set Password",async()=>{
    if(_busy)return;
    if(f.a.length<6){er.textContent="Min 6 characters.";return;}
    if(f.a!==f.b){er.textContent="Passwords don't match.";return;}
    if(requireOld){
      _busy=true;er.textContent="Verifying‚Ä¶";
      const oldHash=await hashPw(f.old);
      if(oldHash!==S.pw){er.textContent="Current password is wrong.";_busy=false;return;}
    }
    _busy=true;
    const oldPw=S._sessionPw||f.old;
    const newHash=await hashPw(f.a);
    const credKeys=['gmail1','gmail2','gmail3','cronometer','truecoach'];
    for(const k of credKeys){
      if(S.creds[k]){
        const plain=oldPw?await dec(S.creds[k],oldPw):'';
        S.creds[k]=plain?await enc(plain,f.a):'';
      }
    }
    S.pw=newHash;
    S._sessionPw=f.a;
    sv();m.remove();
    S.unlocked=1;R();
    alert('‚úÖ Password updated successfully.');
  },"B Bp",{width:"100%",marginTop:"8px"});
  p2.addEventListener("keydown",e=>{if(e.key==="Enter")s.click();});
  const fields=[oldRow,FL("New Password",p1),FL("Confirm",p2),er,s].filter(Boolean);
  const m=ml(requireOld?"Change Password":"Set Password",h("div",{style:{display:"flex",flexDirection:"column",gap:"10px"}},fields));
}

// ‚îÄ‚îÄ App shell ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const TABS=[["today","Today","üìã"],["work","Work","üè¢"],["life","Life","üè†"],["shehulk","She-Hulk","üí™"],["mind","Mind","üß†"],["blacksmith","Smith","üî®"],["settings","Settings","‚öôÔ∏è"]];
const TARDIS_SVG='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><linearGradient id="bgh" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:#2d4c65"/><stop offset="100%" style="stop-color:#1a3548"/></linearGradient></defs><rect x="45" y="5" width="10" height="4" fill="#2850a0" stroke="#000" stroke-width="0.5"/><rect x="47.5" y="3" width="5" height="2" fill="#ffcc00"/><rect x="35" y="9.5" width="30" height="7" fill="#001533"/><text x="50" y="14.5" font-family="Arial,sans-serif" font-size="5" font-weight="bold" fill="#fff" text-anchor="middle">POLICE BOX</text><rect x="30" y="16.5" width="40" height="70" fill="url(#bgh)" stroke="#000" stroke-width="1.5"/><rect x="34" y="21" width="8" height="9" fill="#ddeeff" stroke="#000" stroke-width="0.8"/><rect x="45" y="21" width="8" height="9" fill="#ddeeff" stroke="#000" stroke-width="0.8"/><rect x="56" y="21" width="8" height="9" fill="#ddeeff" stroke="#000" stroke-width="0.8"/><rect x="34" y="33" width="8" height="9" fill="#ddeeff" stroke="#000" stroke-width="0.8"/><rect x="45" y="33" width="8" height="9" fill="#ddeeff" stroke="#000" stroke-width="0.8"/><rect x="56" y="33" width="8" height="9" fill="#ddeeff" stroke="#000" stroke-width="0.8"/><rect x="40" y="50" width="20" height="28" fill="#8a8a75" stroke="#000" stroke-width="1"/><rect x="42" y="52" width="7" height="24" fill="#707060" stroke="#000" stroke-width="0.5"/><rect x="51" y="52" width="7" height="24" fill="#707060" stroke="#000" stroke-width="0.5"/><rect x="30" y="80.5" width="40" height="6" fill="#000"/></svg>';
function rApp(){const w=h("div");const hdr=h("div",{style:{background:P,color:"#fff",padding:"14px 20px",display:"flex",justifyContent:"space-between",alignItems:"center"}});const tardisIcon=h("div",{style:{width:"40px",height:"46px",marginRight:"12px"}});tardisIcon.innerHTML=TARDIS_SVG;hdr.appendChild(h("div",{style:{display:"flex",alignItems:"center"}},[tardisIcon,h("div",{},[h("div",{style:{fontSize:"20px",fontWeight:"900"}},["Dr. Way's T.A.R.D.I.S."]),h("div",{style:{fontSize:"10px",color:"#aec8e8",fontStyle:"italic"}},['"I always take you where you need to go."'])])]));hdr.appendChild($("üîí",()=>{S.unlocked=0;R();},"",{background:"rgba(255,255,255,.15)",border:"none",borderRadius:"8px",padding:"6px 10px",color:"#fff",fontSize:"18px"}));w.appendChild(hdr);
  const tb=h("div",{class:"T"});TABS.forEach(([id,l,ic])=>{const x=h("button",{class:"Ti"+(S.tab===id?" a":""),onclick:()=>{S.tab=id;R();}});const sp1=h("span",{style:{fontSize:"16px"}});sp1.textContent=ic;const sp2=h("span");sp2.textContent=l;x.appendChild(sp1);x.appendChild(sp2);tb.appendChild(x);});w.appendChild(tb);
  const ct=h("div",{id:"ct"});
  const tabFns={today:rToday,work:rWork,life:rLife,shehulk:rSH,mind:rMind,blacksmith:rBS,settings:rSet};
  if(tabFns[S.tab]){try{tabFns[S.tab](ct);}catch(err){console.error("Tab render error:",err);ct.appendChild(h("div",{style:{padding:"20px",color:"#e74c3c"}},["Error loading tab: "+err.message]));}}
  w.appendChild(ct);return w;}

// ‚îÄ‚îÄ Today ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function rToday(w){w.appendChild(SB([["tasks","üìã Tasks"],["cal","üìÖ Calendar"],["morning","üåÖ Morning"],["evening","üåô Evening"]],S.u.ts,v=>{S.u.ts=v;R();}));if(S.u.ts==="morning")rMorningCk(w);else if(S.u.ts==="evening")rEveningCk(w);else S.u.ts==="tasks"?rTasks(w):rCal(w);}
function rMorningCk(w){const ck=S.morningCk||[];const dn=ck.filter(i=>i.done).length;w.appendChild(H("üåÖ Morning Checklist",[$("Reset All",()=>{ck.forEach(i=>i.done=0);sv();R();},"Bs Bo")]));const c=C([]);ck.forEach(i=>{const itemDiv=h("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto",gap:"8px",alignItems:"center",padding:"8px 0",borderBottom:"1px solid #eee",width:"100%"}});itemDiv.appendChild(CK(i.done,()=>{i.done=i.done?0:1;sv();R();}));itemDiv.appendChild(ED(i.text||"Untitled",v=>{i.text=v;sv();R();}));itemDiv.appendChild(DL(()=>{S.morningCk=S.morningCk.filter(x=>x.id!==i.id);sv();R();}));c.appendChild(itemDiv);});c.appendChild(AI("Add morning item...",v=>{S.morningCk.push({id:uid(),text:v,done:0});sv();}));c.appendChild(h("div",{style:{marginTop:"12px",textAlign:"center"}},[h("div",{style:{fontSize:"13px",fontWeight:"700",color:dn===ck.length&&ck.length?"#27ae60":"#e74c3c"}},[dn+"/"+ck.length+" complete"]),PB(ck.length?Math.round(dn/ck.length*100):0,dn===ck.length&&ck.length?"#27ae60":"#2980b9")]));w.appendChild(c);}
function rEveningCk(w){const ck=S.eveningCk||[];const dn=ck.filter(i=>i.done).length;w.appendChild(H("üåô Evening Checklist",[$("Reset All",()=>{ck.forEach(i=>i.done=0);sv();R();},"Bs Bo")]));const c=C([]);ck.forEach(i=>{const itemDiv=h("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto",gap:"8px",alignItems:"center",padding:"8px 0",borderBottom:"1px solid #eee",width:"100%"}});itemDiv.appendChild(CK(i.done,()=>{i.done=i.done?0:1;sv();R();}));itemDiv.appendChild(ED(i.text||"Untitled",v=>{i.text=v;sv();R();}));itemDiv.appendChild(DL(()=>{S.eveningCk=S.eveningCk.filter(x=>x.id!==i.id);sv();R();}));c.appendChild(itemDiv);});c.appendChild(AI("Add evening item...",v=>{S.eveningCk.push({id:uid(),text:v,done:0});sv();}));c.appendChild(h("div",{style:{marginTop:"12px",textAlign:"center"}},[h("div",{style:{fontSize:"13px",fontWeight:"700",color:dn===ck.length&&ck.length?"#27ae60":"#e74c3c"}},[dn+"/"+ck.length+" complete"]),PB(ck.length?Math.round(dn/ck.length*100):0,dn===ck.length&&ck.length?"#27ae60":"#2980b9")]));w.appendChild(c);}
function spawnRecurring(){const td=new Date(),dw=td.getDay();let changed=false;(S.rec||[]).forEach(r=>{if((S.tasks||[]).some(t=>t.rid===r.id&&t.dueDate===TD))return;let sp=0;if(r.recurrence==="Daily")sp=1;else if(r.recurrence==="Weekdays")sp=dw>=1&&dw<=5;else if(r.recurrence==="Weekly")sp=dw===new Date(r.createdDate).getDay();else if(r.recurrence==="Monthly")sp=td.getDate()===new Date(r.createdDate).getDate();if(sp){S.tasks.push({...r,id:uid(),rid:r.id,dueDate:TD,completed:0});changed=true;}});if(changed)sv();}
let _recurringSpawnedDate='';
function rTasks(w){if(_recurringSpawnedDate!==TD){_recurringSpawnedDate=TD;spawnRecurring();}
  const tw=(S.swk||[]).filter(x=>x.date===TD&&!x.done);const alltasks=getAllTasks();const flt=alltasks.filter(t=>!t.completed&&(S.u.tf==="All"||t.bucket===S.u.tf));const dn=alltasks.filter(t=>t.completed&&(S.u.tf==="All"||t.bucket===S.u.tf));
  const tev=getAllCalEv().filter(e=>e.date===TD).sort((a,b)=>(a.time||"z").localeCompare(b.time||"z"));
  const fs=sl(S.u.tf,v=>{S.u.tf=v;R();},["All",...BK]);fs.style.fontSize="12px";
  w.appendChild(H("Today's Tasks",[fs,$("+ Task",()=>addTM(),"Bs Bp")]));
  if(tev.length){const c=C([],{background:"#f0f4ff",borderLeft:"4px solid "+P});c.appendChild(h("div",{style:{fontWeight:"700",fontSize:"13px",color:P,marginBottom:"6px"}},["üìÖ Today's Events"]));tev.forEach(e=>{const evDiv=h("div",{style:{display:"flex",alignItems:"center",gap:"8px",padding:"4px 0",borderBottom:"1px solid #e8e8e8",width:"100%"}});evDiv.appendChild(h("span",{style:{flex:"1",fontSize:"13px"}},[(e.time?"‚è∞"+e.time+" ¬∑ ":"")+e.title]));const btnBox=h("div",{style:{display:"flex",gap:"4px"}});const calEvent=S.calEv.find(x=>x.id===e.id);if(calEvent){btnBox.appendChild($("‚úèÔ∏è",()=>editEvModal(calEvent,()=>R()),"",{background:"none",border:"none",cursor:"pointer",color:P,fontSize:"12px"}));btnBox.appendChild(DL(()=>{S.calEv=S.calEv.filter(x=>x.id!==calEvent.id);sv();R();}));}evDiv.appendChild(btnBox);c.appendChild(evDiv);});w.appendChild(c);}
  if(tw.length){const c=C([],{background:"#f0fff4",borderLeft:"4px solid #27ae60"});c.appendChild(h("div",{style:{fontWeight:"700",fontSize:"13px",color:"#27ae60",marginBottom:"6px"}},["üèãÔ∏è Workouts"]));tw.forEach(x=>{c.appendChild(h("div",{style:{display:"flex",alignItems:"center",gap:"8px",padding:"4px 0",borderBottom:"1px solid #e8e8e8",width:"100%"}},[CK(0,()=>{x.done=1;sv();R();}),h("span",{style:{flex:"1",fontSize:"13px"}},[x.type+(x.dur?" ¬∑ "+x.dur+(x.unit==="mi"?" mi":" min"):"")+(x.time?" ¬∑ ‚è∞ "+x.time:"")]),DL(()=>{S.swk=S.swk.filter(y=>y.id!==x.id);sv();R();})]));});w.appendChild(c);}
  PR.forEach(p=>{const ls=flt.filter(t=>t.priority===p);if(!ls.length)return;w.appendChild(h("div",{style:{fontWeight:"700",fontSize:"13px",color:PC[p],margin:"8px 0 4px"}},[p+" Priority"]));ls.forEach(t=>w.appendChild(tC(t)));});
  const noPri=flt.filter(t=>!t.priority);if(noPri.length){w.appendChild(h("div",{style:{fontWeight:"700",fontSize:"13px",color:"#888",margin:"8px 0 4px"}},["Other Tasks"]));noPri.forEach(t=>w.appendChild(tC(t)));}
  if(!flt.length&&!tw.length&&!tev.length)w.appendChild(C([h("div",{style:{textAlign:"center",color:"#aaa",padding:"32px"}},["No tasks üéâ"])]));
  if(dn.length){w.appendChild(h("div",{style:{fontWeight:"700",color:"#27ae60",fontSize:"13px",margin:"12px 0 4px"}},["‚úÖ Done ("+dn.length+")"]));dn.forEach(t=>w.appendChild(tC(t)));}
  if((S.rec||[]).length){const rc=C([],{background:"#f0f4ff"});rc.appendChild(h("div",{style:{fontWeight:"700",marginBottom:"8px",color:P}},["‚ôªÔ∏è Recurring"]));(S.rec||[]).forEach(r=>{rc.appendChild(h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"5px 0",borderBottom:"1px solid #e0e0e0",width:"100%"}},[h("span",{style:{fontSize:"13px"}},[r.title,bg(r.recurrence,"#8e44ad")]),DL(()=>{S.rec=S.rec.filter(x=>x.id!==r.id);sv();R();})]));});w.appendChild(rc);}}
function addTM(){const f={title:"",priority:"Medium",bucket:"Personal",stage:"Not Started",startTime:"",dueDate:"",notes:"",recurrence:"None"};let _saved=false;const m=ml("Add Task",h("div",{style:{display:"flex",flexDirection:"column",gap:"10px"}},[ip("text","",v=>f.title=v,"Title"),h("div",{class:"g2"},[FL("Priority",sl("Medium",v=>f.priority=v,PR)),FL("Bucket",sl("Personal",v=>f.bucket=v,BK)),FL("Stage",sl("Not Started",v=>f.stage=v,ST)),FL("Recurrence",sl("None",v=>f.recurrence=v,RC)),FL("Time",ip("time","",v=>f.startTime=v)),FL("Due",ip("date","",v=>f.dueDate=v))]),ta("",v=>f.notes=v,"Notes...",2),$("Add",()=>{if(_saved||!f.title.trim())return;_saved=true;const t={...f,id:uid(),completed:0,createdDate:TD};if(f.recurrence!=="None")S.rec.push({...t,id:uid()});S.tasks.push(t);sv();m.remove();R();},"B Bp")]));}
function tC(t){const taskTitle=t.title||t.text||t.task||t.name||"Untitled Task";
  const mainDiv=h("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto",gap:"12px",alignItems:"start",marginBottom:"6px",borderLeft:"4px solid "+(PC[t.priority]||"#888"),background:"#fff",borderRadius:"10px",padding:"12px",boxShadow:"0 1px 4px rgba(0,0,0,.06)"}});
  mainDiv.appendChild(CK(t.completed,()=>{t.completed=!t.completed;sv();R();}));
  const contentBox=h("div");
  const titleDiv=h("div",{style:{display:"flex",alignItems:"center",gap:"8px",marginBottom:"6px"}});titleDiv.appendChild(ED(taskTitle,v=>{if(t.title!==undefined)t.title=v;else if(t.text!==undefined)t.text=v;else if(t.task!==undefined)t.task=v;else if(t.name!==undefined)t.name=v;sv();R();}));contentBox.appendChild(titleDiv);
  const badgeRow=h("div",{style:{display:"flex",gap:"4px",flexWrap:"wrap",marginBottom:"4px"}});
  badgeRow.appendChild(bg(t.stage||"Active",t.stage==="Complete"?"#27ae60":"#7f8c8d"));
  badgeRow.appendChild(bg(t.bucket||"Personal",BC[t.bucket]||PL));
  if(t.recurrence&&t.recurrence!=="None")badgeRow.appendChild(bg("‚ôªÔ∏è"+t.recurrence,"#8e44ad"));
  contentBox.appendChild(badgeRow);
  const timeStr=(t.startTime?"‚è∞"+t.startTime+" ":"")+(t.dueDate?"üìÖ"+fmt(t.dueDate):"");
  if(timeStr)contentBox.appendChild(h("div",{style:{fontSize:"12px",color:"#666"}},[timeStr]));
  const notesDiv=h("div",{style:{fontSize:"13px",color:"#444",marginTop:"6px",background:"#f9f9f9",padding:"8px",borderRadius:"6px",display:"none"}},[t.notes||""]);
  contentBox.appendChild(notesDiv);
  const btnBox=h("div",{style:{display:"flex",gap:"4px",alignItems:"flex-start"}});
  if(t.notes){const nb=$("‚ñº",()=>{const isOpen=notesDiv.style.display==="block";notesDiv.style.display=isOpen?"none":"block";nb.textContent=isOpen?"‚ñº":"‚ñ≤";},"",{background:"none",border:"none",cursor:"pointer",fontSize:"14px",padding:"0"});btnBox.appendChild(nb);}
  btnBox.appendChild($("‚úèÔ∏è",()=>{const tf={title:taskTitle,priority:t.priority||"Medium",bucket:t.bucket||"Personal",stage:t.stage||"Not Started",startTime:t.startTime||"",dueDate:t.dueDate||"",notes:t.notes||""};const tm=ml("Edit Task",h("div",{style:{display:"flex",flexDirection:"column",gap:"10px"}},[ip("text",taskTitle,v=>tf.title=v,"Title"),h("div",{class:"g2"},[FL("Priority",sl(t.priority||"Medium",v=>tf.priority=v,PR)),FL("Bucket",sl(t.bucket||"Personal",v=>tf.bucket=v,BK)),FL("Stage",sl(t.stage||"Not Started",v=>tf.stage=v,ST)),FL("Time",ip("time",t.startTime||"",v=>tf.startTime=v)),FL("Due",ip("date",t.dueDate||"",v=>tf.dueDate=v))]),ta(t.notes||"",v=>tf.notes=v,"Notes...",2),$("Save",()=>{if(t.title!==undefined)t.title=tf.title;else if(t.text!==undefined)t.text=tf.title;else if(t.task!==undefined)t.task=tf.title;else if(t.name!==undefined)t.name=tf.title;t.priority=tf.priority;t.bucket=tf.bucket;t.stage=tf.stage;t.startTime=tf.startTime;t.dueDate=tf.dueDate;t.notes=tf.notes;sv();tm.remove();R();},"B Bp")]));},"",{background:"none",border:"none",cursor:"pointer",color:P,fontSize:"12px"}));
  btnBox.appendChild(DL(()=>{if(t.id)S.tasks=S.tasks.filter(x=>x.id!==t.id);sv();R();}));
  mainDiv.appendChild(contentBox);mainDiv.appendChild(btnBox);return mainDiv;}

// ‚îÄ‚îÄ Calendar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function pICS(tx){const e=[];tx.split("BEGIN:VEVENT").slice(1).forEach(bl=>{const g=k=>{const m=bl.match(new RegExp(k+"[^:]*:([^\\r\\n]+)"));return m?m[1].trim():"";};const dr=g("DTSTART")||"";if(!dr)return;const dt=dr.replace(/T.*/,""),ds=dt.length===8?dt.slice(0,4)+"-"+dt.slice(4,6)+"-"+dt.slice(6,8):dt,tr=dr.includes("T")?dr.replace(/.*T/,"").slice(0,4):"",ts=tr?tr.slice(0,2)+":"+tr.slice(2):"",sm=g("SUMMARY").replace(/\\n/g," ").replace(/\\,/g,",");if(sm&&ds)e.push({id:uid(),title:sm,date:ds,time:ts,bucket:"Personal",source:"google"});});return e;}
function gMon(d){const dt=new Date(d+"T00:00:00");const dy=dt.getDay();dt.setDate(dt.getDate()-(dy===0?6:dy-1));return dt;}
function allCI(){return getAllCalEv().sort((a,b)=>(a.time||"z").localeCompare(b.time||"z"));}
function editEvModal(calEvent,onDone){const ef={title:calEvent.title,date:calEvent.date,time:calEvent.time||"",endTime:calEvent.endTime||"",bucket:calEvent.bucket||"Personal",notes:calEvent.notes||""};const em=ml("Edit Event",h("div",{style:{display:"flex",flexDirection:"column",gap:"10px"}},[ip("text",calEvent.title,v=>ef.title=v,"Event title"),h("div",{class:"g2"},[FL("Date",ip("date",calEvent.date,v=>ef.date=v)),FL("Start",ip("time",calEvent.time||"",v=>ef.time=v)),FL("End",ip("time",calEvent.endTime||"",v=>ef.endTime=v)),FL("Bucket",sl(calEvent.bucket||"Personal",v=>ef.bucket=v,BK))]),ta(calEvent.notes||"",v=>ef.notes=v,"Notes...",2),$("Save",()=>{calEvent.title=ef.title;calEvent.date=ef.date;calEvent.time=ef.time;calEvent.endTime=ef.endTime;calEvent.bucket=ef.bucket;calEvent.notes=ef.notes;sv();em.remove();onDone();},"B Bp")]));}
function rCal(w){const all=allCI(),cc=new Date(S.u.cc+"T00:00:00");
  const bfs=sl(S.u.bf,v=>{S.u.bf=v;R();},["All",...BK]);bfs.style.fontSize="11px";const flt=all.filter(x=>S.u.bf==="All"||x.bucket===S.u.bf);
  const vt=$((S.u.calView==="week"?"üìÜ Month":"üìÖ Week"),()=>{S.u.calView=S.u.calView==="week"?"month":"week";R();},"Bs Bo");
  w.appendChild(H("üìÖ Calendar",[bfs,vt,$("üì• ICS",()=>icsM(),"Bs Bo"),$("+ Event",()=>evM(),"Bs Bp")]));
  const leg=h("div",{style:{display:"flex",gap:"6px",flexWrap:"wrap",marginBottom:"8px"}});[["G Google","#34a853"],["‚úì Task","#8e44ad"],["üèã Workout","#27ae60"],["üí≥ Bill","#c0392b"]].forEach(([l,c])=>leg.appendChild(h("span",{style:{fontSize:"10px",background:c,color:"#fff",borderRadius:"4px",padding:"1px 6px"}},[l])));Object.entries(BC).slice(0,4).forEach(([b,c])=>leg.appendChild(h("span",{style:{fontSize:"10px",background:c,color:"#fff",borderRadius:"4px",padding:"1px 6px"}},[b.split(" ")[0]])));w.appendChild(leg);
  const cols_={workout:"#27ae60",task:"#8e44ad",google:"#34a853",bill:"#c0392b",acr_task:"#e67e22",bs_task:"#7f8c8d",wf_project:"#C9A84C",reminder:"#f39c12",recurring_task:"#9b59b6"};
  if(S.u.calView==="month"){
    const mon=new Date(cc.getFullYear(),cc.getMonth(),1);const yr=mon.getFullYear(),mo=mon.getMonth();const firstDay=new Date(yr,mo,1).getDay();const daysInMonth=new Date(yr,mo+1,0).getDate();
    w.appendChild(h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"}},[$("‚óÄ",()=>{const d=new Date(cc);d.setMonth(d.getMonth()-1);S.u.cc=d.toISOString().slice(0,10);R();},"Bs Bp"),h("div",{style:{fontWeight:"700",color:P,fontSize:"14px"}},[mon.toLocaleDateString("en-US",{month:"long",year:"numeric"})]),$(">",()=>{const d=new Date(cc);d.setMonth(d.getMonth()+1);S.u.cc=d.toISOString().slice(0,10);R();},"Bs Bp")]));
    const grid=h("div",{style:{display:"grid",gridTemplateColumns:"repeat(7,1fr)",gap:"2px",border:"1px solid #eee",borderRadius:"10px",overflow:"hidden",background:"#fff"}});
    ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].forEach(d=>grid.appendChild(h("div",{style:{padding:"8px 4px",background:"#f5f6fa",fontSize:"11px",fontWeight:"600",color:"#888",textAlign:"center"}},[d])));
    for(let i=0;i<firstDay;i++)grid.appendChild(h("div",{style:{minHeight:"80px",background:"#f9f9f9"}}));
    for(let day=1;day<=daysInMonth;day++){const dt=new Date(yr,mo,day);const ds=dt.toISOString().slice(0,10);const di=flt.filter(x=>x.date===ds);const it=ds===TD;
      const cell=h("div",{style:{minHeight:"80px",padding:"4px",background:it?"#dce8ff":"#fff",borderRight:"1px solid #eee",borderBottom:"1px solid #eee",cursor:"pointer",overflow:"hidden"},onclick:()=>dayM(ds,flt.filter(x=>x.date===ds))});
      cell.appendChild(h("div",{style:{fontSize:"14px",fontWeight:it?"900":"600",color:it?P:ds<TD?"#ccc":"#333",marginBottom:"2px"}},[String(day)]));
      di.slice(0,3).forEach(x=>cell.appendChild(h("div",{class:"ep",style:{background:cols_[x.source]||(BC[x.bucket]||P),fontSize:"9px"}},[(x.time?x.time+" ":"")+x.title])));
      if(di.length>3)cell.appendChild(h("div",{style:{fontSize:"9px",color:"#888",marginTop:"2px"}},["+"+(di.length-3)+" more"]));
      grid.appendChild(cell);}
    w.appendChild(C([grid],{padding:"0",overflow:"hidden"}));
  }else{
    const mon=gMon(S.u.cc),days=Array.from({length:7},(_,i)=>{const d=new Date(mon);d.setDate(mon.getDate()+i);return d;});
    w.appendChild(h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"}},[$("‚óÄ",()=>{const d=new Date(cc);d.setDate(d.getDate()-7);S.u.cc=d.toISOString().slice(0,10);R();},"Bs Bp"),h("div",{style:{fontWeight:"700",color:P,fontSize:"14px"}},["Week of "+mon.toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})]),$(">",()=>{const d=new Date(cc);d.setDate(d.getDate()+7);S.u.cc=d.toISOString().slice(0,10);R();},"Bs Bp")]));
    const gr=h("div",{style:{display:"flex",overflowX:"auto",border:"1px solid #eee",borderRadius:"10px",background:"#fff"}});
    days.forEach(d=>{const ds=d.toISOString().slice(0,10),di=flt.filter(x=>x.date===ds),it=ds===TD;const col=h("div",{class:"hcol",style:{cursor:"pointer",minHeight:"180px",background:it?"#dce8ff":"#fff"},onclick:()=>dayM(ds,flt.filter(x=>x.date===ds))});
      col.appendChild(h("div",{style:{textAlign:"center",padding:"8px 4px",background:it?P:"#f5f6fa",borderBottom:"1px solid #eee"}},[h("div",{style:{fontSize:"11px",fontWeight:"600",color:it?"#aec8e8":"#888"}},[d.toLocaleDateString("en-US",{weekday:"short"})]),h("div",{style:{fontSize:"20px",fontWeight:"900",color:it?"#fff":ds<TD?"#ccc":P}},[String(d.getDate())]),h("div",{style:{fontSize:"9px",color:it?"#aec8e8":"#aaa"}},[d.toLocaleDateString("en-US",{month:"short"})])]));
      const bd=h("div",{style:{padding:"4px"}});if(!di.length)bd.appendChild(h("div",{style:{fontSize:"10px",color:"#ccc",padding:"4px",textAlign:"center"}},["‚Äì"]));di.forEach(x=>bd.appendChild(h("div",{class:"ep",style:{background:cols_[x.source]||(BC[x.bucket]||P)}},[(x.time?x.time+" ":"")+x.title])));col.appendChild(bd);gr.appendChild(col);});
    w.appendChild(C([gr],{padding:"0",overflow:"hidden"}));}
}
function evM(ds=TD){const f={title:"",date:ds,time:"",endTime:"",bucket:"Personal",notes:""};const m=ml("Add Event",h("div",{style:{display:"flex",flexDirection:"column",gap:"10px"}},[ip("text","",v=>f.title=v,"Event title"),h("div",{class:"g2"},[FL("Date",ip("date",ds,v=>f.date=v)),FL("Start",ip("time","",v=>f.time=v)),FL("End",ip("time","",v=>f.endTime=v)),FL("Bucket",sl("Personal",v=>f.bucket=v,BK))]),ta("",v=>f.notes=v,"Notes...",2),$("Add",()=>{if(!f.title.trim())return;S.calEv.push({...f,id:uid()});sv();m.remove();R();},"B Bp")]));}
function icsM(){let uv="",tv="";const info=h("div",{style:{fontSize:"13px",color:"#555",marginBottom:"10px"}});info.innerHTML="<strong>How to get ICS:</strong><br>1. Google Calendar ‚Üí Settings<br>2. Click calendar ‚Üí Integrate<br>3. Copy <strong>Secret iCal address</strong>";const m=ml("üì• Import Calendar",h("div",{style:{display:"flex",flexDirection:"column",gap:"10px"}},[info,ip("text","",v=>uv=v,"ICS URL..."),$("Import URL",async()=>{if(!uv.trim())return;try{const r=await fetch("https://api.allorigins.win/raw?url="+encodeURIComponent(uv));const t=await r.text();const p=pICS(t);S.icsEv=p;sv();m.remove();R();alert("‚úÖ "+p.length+" events!");}catch{alert("Failed. Paste below.");}},"B Bp",{width:"100%"}),h("div",{style:{borderTop:"1px solid #eee",paddingTop:"10px"}},[ta("",v=>tv=v,"Paste ICS...",4),$("Import Text",()=>{const p=pICS(tv);if(p.length){S.icsEv=p;sv();m.remove();R();alert("‚úÖ "+p.length);}else alert("None.");},"B Bg",{width:"100%",marginTop:"6px"})])]));}
function dayM(ds,items){const dl=new Date(ds+"T00:00:00").toLocaleDateString("en-US",{weekday:"long",month:"long",day:"numeric"});const f=h("div");if(!items.length)f.appendChild(h("div",{style:{color:"#aaa",textAlign:"center",padding:"16px"}},["Nothing."]));const cols_={google:"#34a853",task:"#8e44ad",workout:"#27ae60",pet_appt:"#e91e8c",maint:"#27ae60",learning:"#8e44ad",bill:"#c0392b",acr_task:"#e67e22",bs_task:"#7f8c8d",wf_project:"#C9A84C",reminder:"#f39c12",recurring_task:"#9b59b6"};items.forEach(x=>{const itemDiv=h("div",{style:{display:"flex",gap:"8px",padding:"8px 0",borderBottom:"1px solid #eee",width:"100%"}});itemDiv.appendChild(h("div",{style:{width:"4px",minHeight:"36px",borderRadius:"2px",background:cols_[x.source]||(BC[x.bucket]||P)}}));const contentDiv=h("div",{style:{flex:"1"}});contentDiv.appendChild(h("div",{style:{fontWeight:"700"}},[x.title]));contentDiv.appendChild(h("div",{style:{fontSize:"12px",color:"#666"}},[(x.time?"‚è∞ "+x.time+" ¬∑ ":"")+(x.bucket||"")]));itemDiv.appendChild(contentDiv);const btnBox=h("div",{style:{display:"flex",gap:"4px"}});const calEvent=S.calEv.find(ce=>ce.id===x.id);if(calEvent){btnBox.appendChild($("‚úèÔ∏è",()=>editEvModal(calEvent,()=>{m.remove();R();}),"",{background:"none",border:"none",cursor:"pointer",color:P,fontSize:"12px"}));btnBox.appendChild(DL(()=>{S.calEv=S.calEv.filter(e=>e.id!==calEvent.id);sv();m.remove();R();}));}itemDiv.appendChild(btnBox);f.appendChild(itemDiv);});f.appendChild($("+ Event",()=>{m.remove();evM(ds);},"B Bp",{marginTop:"12px",width:"100%"}));const m=ml(dl,f);}

// ‚îÄ‚îÄ Work ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function rWork(w){w.appendChild(SB([["clo","üè¢ CLO"],["wf","‚öíÔ∏è Way Forged"]],S.u.wk,v=>{S.u.wk=v;R();}));S.u.wk==="clo"?rCLO(w):rWF(w);}
function rCLO(w){const cats=S.cloCats||[];w.appendChild(H("üè¢ CLO Hub",[...["dash","list","kanban","links"].map((v,i)=>$(["üìä","üìã","üóÇ","üîó"][i],()=>{S.u.cv=v;R();},"Bs"+(S.u.cv===v?" Bp":""),{padding:"4px 10px"})),$("+ Cat",()=>{const n=prompt("Name:");if(n){cats.push({id:uid(),name:n,poc:"",tasks:[],subs:[]});sv();R();}},"Bs Bp")]));
  if(S.u.cv==="links"){linksSec(w,"cloLinks","üîó CLO Custom Links");
  }else if(S.u.cv==="dash"){const tt=cats.reduce((s,c)=>s+c.tasks.length,0),dt=cats.reduce((s,c)=>s+c.tasks.filter(x=>x.completed).length,0);const ov=C([],{background:"linear-gradient(135deg,"+P+","+PL+")",color:"#fff"});ov.appendChild(h("div",{style:{fontWeight:"800",marginBottom:"8px",color:"#fff"}},["Overview"]));const sg=h("div",{style:{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:"8px",textAlign:"center"}});[["Total",tt,"#fff"],["Active",tt-dt,"#ffd700"],["Done",dt,"#7eff9a"]].forEach(([l,v,c])=>sg.appendChild(h("div",{style:{background:"rgba(255,255,255,.15)",borderRadius:"8px",padding:"8px"}},[h("div",{style:{fontSize:"24px",fontWeight:"900",color:c}},[String(v)]),h("div",{style:{fontSize:"11px",color:"#fff"}},[l])])));ov.appendChild(sg);if(tt)ov.appendChild(PB(Math.round(dt/tt*100),"#7eff9a"));w.appendChild(ov);
    w.appendChild(h("div",{style:{fontSize:"11px",color:"#888",margin:"6px 0",fontStyle:"italic"}},["Drag tiles to reorder"]));
    const gr=h("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(150px,1fr))",gap:"10px"}});cats.forEach((c,idx)=>{const t=c.tasks.length,d=c.tasks.filter(x=>x.completed).length,p=t?Math.round(d/t*100):0;const cd=h("div",{draggable:"true",style:{background:"#fff",borderRadius:"12px",padding:"12px",boxShadow:"0 2px 8px rgba(0,0,0,.08)",cursor:"grab",borderTop:"4px solid "+P}});
      cd.ondragstart=e=>{dragIdx=idx;cd.classList.add("dragging");e.dataTransfer.effectAllowed="move";};cd.ondragend=()=>{dragIdx=null;cd.classList.remove("dragging");};cd.ondragover=e=>{e.preventDefault();cd.classList.add("drag-over");};cd.ondragleave=()=>cd.classList.remove("drag-over");cd.ondrop=e=>{e.preventDefault();cd.classList.remove("drag-over");if(dragIdx!==null&&dragIdx!==idx){const mv=S.cloCats.splice(dragIdx,1)[0];S.cloCats.splice(idx,0,mv);sv();R();}};
      cd.onclick=()=>{S.u.cv="list";R();};
      cd.appendChild(h("div",{style:{fontWeight:"700",fontSize:"13px",color:P,marginBottom:"4px"}},[c.name]));if(c.desc)cd.appendChild(h("div",{style:{fontSize:"9px",color:"#888",marginBottom:"4px"}},[c.desc]));cd.appendChild(h("div",{style:{fontSize:"12px",color:"#555"}},[t+" tasks"]));if(c.subs&&c.subs.length)cd.appendChild(h("div",{style:{fontSize:"10px",color:"#8e44ad",marginTop:"2px"}},[c.subs.length+" sub-categories"]));if(t)cd.appendChild(PB(p,p===100?"#27ae60":P));gr.appendChild(cd);});w.appendChild(gr);
  }else if(S.u.cv==="kanban"){const all=cats.flatMap(c=>(c.tasks||[]).map(t=>({...t,cn:c.name})));w.appendChild(C([h("div",{class:"kw"},ST.map(s=>{const its=all.filter(t=>(t.stage||"Not Started")===s);return h("div",{class:"kc"},[h("div",{style:{fontWeight:"700",fontSize:"12px",color:P,marginBottom:"8px"}},[s+" ("+its.length+")"]),...its.map(t=>h("div",{style:{background:"#fff",borderRadius:"6px",padding:"6px",marginBottom:"6px",fontSize:"12px",borderLeft:"3px solid "+P}},[h("div",{style:{fontWeight:"600"}},[t.title||""]),h("div",{style:{color:"#888",fontSize:"10px"}},[t.cn||""])]))]);}))]));
  }else{cats.forEach((cat,idx)=>{const op=S.u.cx===cat.id;const c=C([]);const dh=h("span",{draggable:"true",style:{cursor:"grab",color:"#aaa",userSelect:"none",fontSize:"14px"}},[":::"]);dh.ondragstart=e=>{dragIdx=idx;e.dataTransfer.effectAllowed="move";};dh.ondragend=()=>{dragIdx=null;};c.ondragover=e=>{e.preventDefault();c.classList.add("drag-over");};c.ondragleave=()=>c.classList.remove("drag-over");c.ondrop=e=>{e.preventDefault();c.classList.remove("drag-over");if(dragIdx!==null&&dragIdx!==idx){const mv=S.cloCats.splice(dragIdx,1)[0];S.cloCats.splice(idx,0,mv);sv();R();}};
    const ti=h("div",{style:{flex:"1",cursor:"pointer"},onclick:()=>{S.u.cx=op?null:cat.id;R();}});ti.appendChild(h("span",{style:{fontWeight:"700"}},[cat.name]));if(cat.desc)ti.appendChild(h("div",{style:{fontSize:"10px",color:"#888",fontStyle:"italic"}},[cat.desc]));if(cat.poc)ti.appendChild(h("span",{style:{fontSize:"12px",color:"#666",marginLeft:"8px"}},["üë§"+cat.poc]));ti.appendChild(bg(cat.tasks.length,"#7f8c8d"));if(cat.subs&&cat.subs.length)ti.appendChild(bg(cat.subs.length+" subs","#8e44ad"));
    c.appendChild(h("div",{style:{display:"flex",alignItems:"center",gap:"8px",width:"100%"}},[dh,ti,$("‚úèÔ∏è",()=>{const nm=prompt("Name:",cat.name);if(nm)cat.name=nm;const pc=prompt("POC:",cat.poc||"");if(pc!==null)cat.poc=pc;sv();R();},"Bs Bo"),DL(()=>{if(confirm("Delete?"))S.cloCats=S.cloCats.filter(x=>x.id!==cat.id);sv();R();}),$(op?"‚ñ≤":"‚ñº",()=>{S.u.cx=op?null:cat.id;R();},"",{background:"none",border:"none",fontSize:"18px",cursor:"pointer"})]));
    if(op){const bd=h("div",{style:{marginTop:"10px",width:"100%"}});(cat.tasks||[]).forEach(t=>{const taskDiv=h("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto",gap:"8px",alignItems:"start",padding:"6px 0",borderBottom:"1px solid #eee",width:"100%"}});taskDiv.appendChild(CK(t.completed,()=>{t.completed=!t.completed;sv();R();}));const contentDiv=h("div");contentDiv.appendChild(ED(t.title||"Untitled",v=>{t.title=v;sv();R();}));const metaDiv=h("div",{style:{display:"flex",gap:"4px",alignItems:"center",marginTop:"2px"}});if(t.dueDate)metaDiv.appendChild(h("span",{style:{fontSize:"11px",color:"#888"}},["üìÖ"+fmt(t.dueDate)]));metaDiv.appendChild(bg(t.stage||"Not Started",t.stage==="Complete"?"#27ae60":P));contentDiv.appendChild(metaDiv);taskDiv.appendChild(contentDiv);const btnBox=h("div",{style:{display:"flex",gap:"4px"}});btnBox.appendChild($("‚úèÔ∏è",()=>{const tf={title:t.title,stage:t.stage||"Not Started",priority:t.priority||"Medium",poc:t.poc||"",dueDate:t.dueDate||"",startTime:t.startTime||""};const tm=ml("Edit Task",h("div",{style:{display:"flex",flexDirection:"column",gap:"8px"}},[ip("text",t.title,v=>tf.title=v,"Task"),h("div",{class:"g2"},[sl(t.stage||"Not Started",v=>tf.stage=v,ST),sl(t.priority||"Medium",v=>tf.priority=v,PR),ip("text",t.poc||"",v=>tf.poc=v,"POC"),ip("date",t.dueDate||"",v=>tf.dueDate=v,"Due Date"),ip("time",t.startTime||"",v=>tf.startTime=v,"Start Time")]),$("Save",()=>{t.title=tf.title;t.stage=tf.stage;t.priority=tf.priority;t.poc=tf.poc;t.dueDate=tf.dueDate;t.startTime=tf.startTime;sv();tm.remove();R();},"B Bp")]));},"",{background:"none",border:"none",cursor:"pointer",color:P,fontSize:"12px"}));btnBox.appendChild(DL(()=>{cat.tasks=cat.tasks.filter(x=>x.id!==t.id);sv();R();}));taskDiv.appendChild(btnBox);bd.appendChild(taskDiv);});
      bd.appendChild($("+ Task",()=>{const f={title:"",stage:"Not Started",priority:"Medium",poc:"",dueDate:"",startTime:""};const m_=ml("Add Task",h("div",{style:{display:"flex",flexDirection:"column",gap:"8px"}},[ip("text","",v=>f.title=v,"Task"),h("div",{class:"g2"},[sl("Not Started",v=>f.stage=v,ST),sl("Medium",v=>f.priority=v,PR),ip("text","",v=>f.poc=v,"POC"),ip("date","",v=>f.dueDate=v,"Due Date"),ip("time","",v=>f.startTime=v,"Start Time")]),$("Add",()=>{if(!f.title.trim())return;cat.tasks.push({id:uid(),...f,completed:0});sv();m_.remove();R();},"Bs Bp")]));},"Bs Bp",{marginTop:"8px"}));
      bd.appendChild(h("div",{style:{fontWeight:"700",fontSize:"13px",margin:"14px 0 6px",color:"#8e44ad"}},["Sub-categories"]));
      (cat.subs||[]).forEach(sub=>{const sop=S.u.ae["sub_"+sub.id];const sc=h("div",{style:{background:"#f8f9ff",borderRadius:"8px",padding:"8px",marginBottom:"6px",borderLeft:"3px solid #8e44ad"}});sc.appendChild(h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",cursor:"pointer",width:"100%"},onclick:()=>{S.u.ae["sub_"+sub.id]=!sop;R();}},[h("span",{style:{fontWeight:"600",fontSize:"13px"}},[sub.name,bg((sub.tasks||[]).length,"#8e44ad")]),h("div",{style:{display:"flex",gap:"4px"}},[$("‚úèÔ∏è",()=>{const nm=prompt("Edit sub-category name:",sub.name);if(nm!==null&&nm.trim()){sub.name=nm.trim();sub.lastEdited=TD;sv();R();}},"",{background:"none",border:"none",cursor:"pointer",color:P,fontSize:"12px"}),DL(()=>{cat.subs=cat.subs.filter(x=>x.id!==sub.id);sv();R();}),h("span",{style:{fontSize:"14px"}},[sop?"‚ñ≤":"‚ñº"])])]));if(sop){const sbd=h("div",{style:{marginTop:"6px",width:"100%"}});(sub.tasks||[]).forEach(t=>{const taskDiv=h("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto auto auto",gap:"6px",alignItems:"center",padding:"3px 0",fontSize:"12px",width:"100%"}});taskDiv.appendChild(CK(t.done,()=>{t.done=!t.done;sv();R();}));const taskContent=h("div",{style:{flex:"1"}});taskContent.appendChild(ED(t.title||t.text||"Untitled",v=>{if(t.title!==undefined)t.title=v;else t.text=v;t.lastEdited=TD;sv();R();}));if(t.dueDate)taskContent.appendChild(h("div",{style:{fontSize:"9px",color:"#888",marginTop:"2px"}},["üìÖ "+fmt(t.dueDate)]));taskDiv.appendChild(taskContent);taskDiv.appendChild($("‚úèÔ∏è",()=>{const tf={title:t.title||t.text||"Untitled",dueDate:t.dueDate||""};const tm=ml("Edit Task",h("div",{style:{display:"flex",flexDirection:"column",gap:"8px"}},[ip("text",t.title||t.text,v=>tf.title=v,"Task"),ip("date",t.dueDate||"",v=>tf.dueDate=v,"Due Date"),$("Save",()=>{if(t.title!==undefined)t.title=tf.title.trim();else t.text=tf.title.trim();t.dueDate=tf.dueDate;t.lastEdited=TD;sv();tm.remove();R();},"B Bp")]));},"",{background:"none",border:"none",cursor:"pointer",color:P,fontSize:"11px"}));taskDiv.appendChild($("üìÖ",()=>{const d=prompt("Due date (YYYY-MM-DD):",t.dueDate||"");if(d!==null){t.dueDate=d||null;sv();R();}},"",{background:"none",border:"none",cursor:"pointer",color:P,fontSize:"11px",title:"Quick date"}));taskDiv.appendChild(DL(()=>{sub.tasks=sub.tasks.filter(x=>x.id!==t.id);sv();R();}));sbd.appendChild(taskDiv);});sbd.appendChild(AI("Add task...",v=>{if(!sub.tasks)sub.tasks=[];sub.tasks.push({id:uid(),title:v,done:0,dueDate:null});sv();}));if(sub.lastEdited)sbd.appendChild(h("div",{style:{fontSize:"9px",color:"#888",marginTop:"4px",fontStyle:"italic"}},["Last edited: "+fmt(sub.lastEdited)]));sc.appendChild(sbd);}bd.appendChild(sc);});
      bd.appendChild($("+ Sub-category",()=>{const n=prompt("Sub-category name:");if(n){if(!cat.subs)cat.subs=[];cat.subs.push({id:uid(),name:n,tasks:[],lastEdited:TD});sv();R();}},"Bs Bo",{marginTop:"4px"}));
      c.appendChild(bd);}w.appendChild(c);});}}
function rWF(w){w.appendChild(H("‚öíÔ∏è Way Forged",[$("+ Project",()=>{const f={title:"",description:"",stage:"Not Started",poc:"",pocContact:"",dueDate:""};const m=ml("Add Project",h("div",{style:{display:"flex",flexDirection:"column",gap:"10px"}},[ip("text","",v=>f.title=v,"Title"),ta("",v=>f.description=v,"Desc...",2),h("div",{class:"g2"},[FL("Stage",sl("Not Started",v=>f.stage=v,ST)),FL("Due",ip("date","",v=>f.dueDate=v)),ip("text","",v=>f.poc=v,"POC"),ip("text","",v=>f.pocContact=v,"Contact")]),$("Add",()=>{if(!f.title.trim())return;S.wfP.push({id:uid(),...f,tasks:[],notes:[],cd:TD});sv();m.remove();R();},"B Bp")]));},"Bs Bp")]));
  w.appendChild(SB([["projects","üìù Projects"],["links","üîó Links"]],S.u.wx?"links":"projects",v=>{S.u.wx=v==="links"?"links":null;R();}));
  if(S.u.wx==="links"){linksSec(w,"wfLinks","üîó Way Forged Custom Links");
  }else{(S.wfP||[]).forEach(p=>{const op=S.u.wx===p.id;const c=C([],{borderLeft:"4px solid "+GL});c.appendChild(h("div",{style:{display:"flex",alignItems:"flex-start",gap:"8px",width:"100%"}},[h("div",{style:{flex:"1",cursor:"pointer"},onclick:()=>{S.u.wx=op?null:p.id;R();}},[h("div",{style:{fontWeight:"700"}},[p.title]),bg(p.stage),p.dueDate?h("div",{style:{fontSize:"11px",color:"#888",marginTop:"2px"}},["üìÖ "+fmt(p.dueDate)]):null,p.poc?h("span",{style:{fontSize:"12px",color:"#666",marginLeft:"8px"}},["üë§"+p.poc]):null]),h("div",{style:{display:"flex",gap:"4px"}},[$("‚úèÔ∏è",()=>{const pf={title:p.title,description:p.description||"",stage:p.stage,poc:p.poc||"",pocContact:p.pocContact||"",dueDate:p.dueDate||""};const dtx=ta(p.description||"",v=>pf.description=v,"Description...",2);dtx.style.width="100%";const pm=ml("Edit Project",h("div",{style:{display:"flex",flexDirection:"column",gap:"10px"}},[ip("text",p.title,v=>pf.title=v,"Title"),dtx,h("div",{class:"g2"},[FL("Stage",sl(p.stage,v=>pf.stage=v,ST)),FL("Due",ip("date",p.dueDate||"",v=>pf.dueDate=v)),ip("text",p.poc||"",v=>pf.poc=v,"POC"),ip("text",p.pocContact||"",v=>pf.pocContact=v,"Contact")]),$("Save",()=>{p.title=pf.title;p.description=pf.description;p.stage=pf.stage;p.poc=pf.poc;p.pocContact=pf.pocContact;p.dueDate=pf.dueDate;p.lastEdited=TD;sv();pm.remove();R();},"B Bp")]));},"",{background:"none",border:"none",cursor:"pointer",color:P,fontSize:"12px"}),DL(()=>{S.wfP=S.wfP.filter(x=>x.id!==p.id);sv();R();})])]));if(op){const bd=h("div",{style:{marginTop:"12px",width:"100%"}});if(p.description)bd.appendChild(h("p",{style:{margin:"0 0 8px",fontSize:"13px",color:"#444"}},[p.description]));bd.appendChild(FL("Stage",sl(p.stage,v=>{p.stage=v;sv();R();},ST)));bd.appendChild(h("div",{style:{fontWeight:"600",fontSize:"13px",margin:"8px 0 4px"}},["Tasks"]));(p.tasks||[]).forEach(t=>{bd.appendChild(h("div",{style:{display:"flex",gap:"6px",padding:"3px 0",fontSize:"13px",alignItems:"center",width:"100%"}},[CK(t.completed,()=>{t.completed=!t.completed;sv();R();}),h("span",{style:{flex:"1",textDecoration:t.completed?"line-through":"none"}},[t.title||""]),DL(()=>{p.tasks=p.tasks.filter(x=>x.id!==t.id);sv();R();})]));});bd.appendChild(AI("Add task...",v=>{if(!p.tasks)p.tasks=[];p.tasks.push({id:uid(),title:v,completed:0});sv();}));bd.appendChild(h("div",{style:{fontWeight:"600",fontSize:"13px",margin:"10px 0 4px"}},["Notes"]));(p.notes||[]).forEach(n=>{bd.appendChild(h("div",{style:{background:"#f9f9f9",borderRadius:"6px",padding:"6px",marginBottom:"4px",fontSize:"12px"}},[fmt(n.date)+" ‚Äì "+(n.text||"")]));});bd.appendChild(AI("Add note...",v=>{if(!p.notes)p.notes=[];p.notes.push({id:uid(),text:v,date:TD});sv();}));if(p.lastEdited)bd.appendChild(h("div",{style:{fontSize:"9px",color:"#888",marginTop:"6px",fontStyle:"italic"}},["Last edited: "+fmt(p.lastEdited)]));c.appendChild(bd);}w.appendChild(c);});
  if(!S.wfP.length)w.appendChild(C([h("div",{style:{textAlign:"center",color:"#aaa",padding:"24px"}},["No projects."])]));}
}

// ‚îÄ‚îÄ Life ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function rLife(w){w.appendChild(SB([["grocery","üõí Grocery"],["pets","üêæ Pets"],["budget","üí∞ Budget"],["home","üè† Home"]],S.u.lk,v=>{S.u.lk=v;R();}));({grocery:rGr,pets:rPe,budget:rBu,home:rHo})[S.u.lk](w);}
function rGr(w){w.appendChild(H("üõí Grocery",[$("Clear ‚úì",()=>{S.gM=S.gM.filter(i=>!i.ck);sv();R();},"Bs Bd")]));const c=C([]);c.appendChild(AI("Add item...",v=>{S.gM.push({id:uid(),text:v,ck:0});sv();}));(S.gM||[]).filter(i=>!i.ck).forEach(i=>{const itemDiv=h("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto auto",gap:"8px",alignItems:"center",padding:"6px 0",borderBottom:"1px solid #eee",width:"100%"}});itemDiv.appendChild(CK(0,()=>{i.ck=1;sv();R();}));itemDiv.appendChild(ED(i.text||"Untitled",v=>{i.text=v;i.lastEdited=TD;sv();R();}));itemDiv.appendChild($("‚úèÔ∏è",()=>{const nt=prompt("Edit item:",i.text);if(nt!==null&&nt.trim()){i.text=nt.trim();i.lastEdited=TD;sv();R();}},"",{background:"none",border:"none",cursor:"pointer",color:P,fontSize:"12px"}));itemDiv.appendChild(DL(()=>{S.gM=S.gM.filter(x=>x.id!==i.id);sv();R();}));c.appendChild(itemDiv);});const dk=(S.gM||[]).filter(i=>i.ck);if(dk.length){c.appendChild(h("div",{style:{borderTop:"2px dashed #eee",marginTop:"6px",paddingTop:"6px",width:"100%"}}));dk.forEach(i=>{c.appendChild(h("div",{style:{display:"flex",alignItems:"center",gap:"8px",padding:"4px 0",width:"100%"}},[CK(1,()=>{i.ck=0;sv();R();}),h("span",{style:{textDecoration:"line-through",color:"#aaa"}},[i.text||""])]));});}w.appendChild(c);}
function rPe(w){const pet=S.pets.find(p=>p.id===S.u.pa);w.appendChild(H("üêæ Pets"));w.appendChild(h("div",{style:{display:"flex",gap:"8px",marginBottom:"12px"}},S.pets.map(p=>$(p.name,()=>{S.u.pa=p.id;R();},"B"+(S.u.pa===p.id?" Bp":""),{flex:"1",padding:"10px",borderRadius:"8px",border:"none",fontWeight:"700"}))));w.appendChild(SB([["training","üéæ Train"],["appointments","üìÖ Appts"],["games","üéÆ Games"],["links","üîó Links"]],S.u.ps,v=>{S.u.ps=v;R();}));if(!pet)return;
  if(S.u.ps==="training"){const c=C([]);(pet.tr||[]).forEach(t=>{const itemDiv=h("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto auto",gap:"8px",alignItems:"center",padding:"5px 0",borderBottom:"1px solid #eee",width:"100%"}});itemDiv.appendChild(CK(t.done,()=>{t.done=!t.done;sv();R();}));itemDiv.appendChild(ED(t.text||"Untitled",v=>{t.text=v;t.lastEdited=TD;sv();R();}));itemDiv.appendChild($("‚úèÔ∏è",()=>{const nt=prompt("Edit:",t.text);if(nt!==null&&nt.trim()){t.text=nt.trim();t.lastEdited=TD;sv();R();}},"",{background:"none",border:"none",cursor:"pointer",color:P,fontSize:"12px"}));itemDiv.appendChild(DL(()=>{pet.tr=pet.tr.filter(x=>x.id!==t.id);sv();R();}));c.appendChild(itemDiv);});c.appendChild(AI("Add...",v=>{if(!pet.tr)pet.tr=[];pet.tr.push({id:uid(),text:v,done:0});sv();}));w.appendChild(c);
  }else if(S.u.ps==="appointments"){const c=C([]);(pet.ap||[]).sort((a,b)=>(a.date||"").localeCompare(b.date||"")).forEach(a=>{c.appendChild(h("div",{style:{display:"flex",justifyContent:"space-between",padding:"5px 0",borderBottom:"1px solid #eee",fontSize:"13px",width:"100%"}},[h("span",{},["üìÖ"+fmt(a.date)+(a.note?" ‚Äì "+a.note:"")]),h("div",{style:{display:"flex",gap:"4px"}},[$("‚úèÔ∏è",()=>{const af={date:a.date,note:a.note||""};const am=ml("Edit Appointment",h("div",{style:{display:"flex",flexDirection:"column",gap:"8px"}},[ip("date",a.date,v=>af.date=v),ip("text",a.note||"",v=>af.note=v,"Note"),$("Save",()=>{a.date=af.date;a.note=af.note;a.lastEdited=TD;sv();am.remove();R();},"B Bp")]));},"",{background:"none",border:"none",cursor:"pointer",color:P,fontSize:"12px"}),DL(()=>{pet.ap=pet.ap.filter(x=>x.id!==a.id);sv();R();})])]));});const di=ip("date",TD,()=>{});const ni=ip("text","",()=>{},"Note");c.appendChild(h("div",{class:"g2",style:{marginTop:"8px"}},[di,ni]));c.appendChild($("Add",()=>{if(!pet.ap)pet.ap=[];pet.ap.push({id:uid(),date:di.value,note:ni.value});sv();R();},"Bs Bp",{marginTop:"8px"}));w.appendChild(c);
  }else if(S.u.ps==="games"){const c=C([]);(pet.gm||[]).forEach(g=>{c.appendChild(h("div",{style:{display:"flex",alignItems:"center",gap:"8px",padding:"6px 0",borderBottom:"1px solid #eee",width:"100%"}},[ED(g.name||"",v=>{g.name=v;g.lastEdited=TD;sv();R();}),h("span",{style:{fontWeight:"700",color:g.c>=2?"#27ae60":"#e74c3c"}},[g.c+"/2"]),$("‚úèÔ∏è",()=>{const nm=prompt("Edit game:",g.name);if(nm!==null&&nm.trim()){g.name=nm.trim();g.lastEdited=TD;sv();R();}},"",{background:"none",border:"none",cursor:"pointer",color:P,fontSize:"12px"}),$(" +1",()=>{g.c++;sv();R();},"Bs Bg"),DL(()=>{pet.gm=pet.gm.filter(x=>x.id!==g.id);sv();R();})]));});c.appendChild(AI("Add game...",v=>{if(!pet.gm)pet.gm=[];pet.gm.push({id:uid(),name:v,c:0,lastEdited:TD});sv();}));w.appendChild(c);
  }else if(S.u.ps==="links"){linksSec(w,"petLinks","üîó Pet Custom Links");}
}
function rBu(w){const k=S.u.bt,ls=S.exp[k]||[],tot=ls.reduce((s,e)=>s+Number(e.amount||0),0),inc=Number(S.inc[k]||0);w.appendChild(H("üí∞ Budget",[$("CSV",()=>{const rows=[["Date","Desc","Cat","Amt"],...ls.map(e=>[e.date,e.desc,e.cat,e.amount])];const a=document.createElement("a");a.href="data:text/csv,"+encodeURIComponent(rows.map(r=>r.join(",")).join("\n"));a.download="budget-"+k+"-"+TD+".csv";a.click();},"Bs Bo")]));
  w.appendChild(h("div",{style:{display:"flex",gap:"8px",marginBottom:"12px"}},["personal","wayForged"].map(t=>$(t==="personal"?"Personal":"Way Forged",()=>{S.u.bt=t;R();},"B"+(k===t?" Bp":""),{flex:"1",padding:"10px",borderRadius:"8px",border:"none",fontWeight:"700"}))));
  const sc=C([]);const ii=h("input",{type:"number",style:{width:"100px",fontSize:"18px",fontWeight:"700",color:"#27ae60"}});ii.value=inc;ii.oninput=e=>{S.inc[k]=e.target.value;sv();};sc.appendChild(h("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"8px"}},[h("div",{},[h("div",{style:{fontSize:"12px",color:"#666"}},["Income"]),ii]),h("div",{style:{textAlign:"right"}},[h("div",{style:{fontSize:"12px",color:"#666"}},["Spent"]),h("div",{style:{fontSize:"20px",fontWeight:"700",color:"#e74c3c"}},[fm$(tot)])]),h("div",{style:{textAlign:"right"}},[h("div",{style:{fontSize:"12px",color:"#666"}},["Left"]),h("div",{style:{fontSize:"20px",fontWeight:"700",color:inc-tot>=0?"#27ae60":"#e74c3c"}},[fm$(inc-tot)])])]));if(inc>0)sc.appendChild(PB(Math.round(tot/inc*100),tot/inc>1?"#e74c3c":"#2980b9"));w.appendChild(sc);
  const f={desc:"",amount:"",cat:"General",date:TD};w.appendChild(C([h("div",{class:"g2"},[ip("text","",v=>f.desc=v,"Desc"),ip("number","",v=>f.amount=v,"Amt"),ip("text","General",v=>f.cat=v,"Cat"),ip("date",TD,v=>f.date=v)]),$("Add Expense",()=>{if(!f.desc||!f.amount)return;if(!S.exp[k])S.exp[k]=[];S.exp[k].push({...f,id:uid(),created:TD});sv();R();},"B Bp",{marginTop:"8px"})]));
  ls.forEach(e=>{w.appendChild(C([h("div",{style:{display:"flex",justifyContent:"space-between",width:"100%"}},[h("div",{},[h("strong",{},[e.desc||""]),h("div",{style:{fontSize:"12px",color:"#666"}},[(e.cat||"")+" ¬∑ "+fmt(e.date)])]),h("div",{style:{display:"flex",gap:"6px",alignItems:"center"}},[$("‚úèÔ∏è",()=>{const ef={desc:e.desc,amount:e.amount,cat:e.cat,date:e.date};const em=ml("Edit Expense",h("div",{style:{display:"flex",flexDirection:"column",gap:"8px"}},[h("div",{class:"g2"},[ip("text",e.desc,v=>ef.desc=v,"Desc"),ip("number",e.amount,v=>ef.amount=v,"Amt"),ip("text",e.cat,v=>ef.cat=v,"Cat"),ip("date",e.date,v=>ef.date=v)]),$("Save",()=>{e.desc=ef.desc;e.amount=ef.amount;e.cat=ef.cat;e.date=ef.date;e.lastEdited=TD;sv();em.remove();R();},"B Bp")]));},"",{background:"none",border:"none",cursor:"pointer",color:P,fontSize:"12px"}),h("span",{style:{fontWeight:"700",color:"#e74c3c"}},[fm$(e.amount)]),DL(()=>{S.exp[k]=S.exp[k].filter(x=>x.id!==e.id);sv();R();})])])],{padding:"10px"}));});}
function rHo(w){w.appendChild(SB([["bills","üí≥ Bills"],["rem","üìù Remind"],["maint","üîß Maint"],["subs","üì¶ Subs"],["checklist","‚úì Leaving"],["links","üîó Links"]],S.u.ht,v=>{S.u.ht=v;R();}));
  if(S.u.ht==="bills"){const today=new Date();const curY=today.getFullYear(),curM=today.getMonth();const sorted=[...(S.bills||[])].sort((a,b)=>{if(a.recurrence==="One-time"&&b.recurrence==="One-time")return(a.date||"").localeCompare(b.date||"");if(a.recurrence==="One-time")return 1;if(b.recurrence==="One-time")return -1;return a.day-b.day;});w.appendChild(H("üí≥ Bills",[$("+ Bill",()=>{const f={n:"",recurrence:"Monthly",day:"",date:"",a:""};const recSel=sl("Monthly",v=>{f.recurrence=v;const dateInput=document.getElementById("billDateInput");const dayInput=document.getElementById("billDayInput");if(dateInput&&dayInput){if(v==="One-time"){dateInput.style.display="block";dayInput.style.display="none";}else{dateInput.style.display="none";dayInput.style.display="block";}}},[{value:"Monthly",label:"Monthly"},{value:"One-time",label:"One-time"}]);const dayInput=ip("number","",v=>f.day=v,"Due day (1-31)");dayInput.id="billDayInput";const dateInput=ip("date","",v=>f.date=v,"Due date");dateInput.id="billDateInput";dateInput.style.display="none";const m=ml("Add Bill",h("div",{style:{display:"flex",flexDirection:"column",gap:"8px"}},[ip("text","",v=>f.n=v,"Name"),recSel,dayInput,dateInput,ip("number","",v=>f.a=v,"Amount"),$("Add",()=>{if(!f.n||!f.a)return;if(f.recurrence==="Monthly"&&!f.day)return;if(f.recurrence==="One-time"&&!f.date)return;S.bills.push({id:uid(),n:f.n,recurrence:f.recurrence,day:f.recurrence==="Monthly"?f.day:null,date:f.recurrence==="One-time"?f.date:null,a:f.a,paid:0,created:TD});sv();m.remove();R();},"B Bp")]));},"Bs Bp")]));const gr=h("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(180px,1fr))",gap:"10px"}});sorted.forEach((b,idx)=>{let dueDateStr="";if(b.recurrence==="Monthly"){const dueDate=new Date(curY,curM,b.day);dueDateStr=dueDate.toLocaleDateString("en-US",{month:"short",day:"numeric"});}else{dueDateStr=fmt(b.date);}const cd=h("div",{draggable:"true",style:{background:"#fff",borderRadius:"12px",padding:"12px",boxShadow:"0 2px 8px rgba(0,0,0,.08)",cursor:"grab",opacity:b.paid?.6:1,borderTop:"4px solid "+(b.paid?"#27ae60":"#e74c3c")}});
      cd.ondragstart=e=>{dragIdx=idx;cd.classList.add("dragging");e.dataTransfer.effectAllowed="move";};cd.ondragend=()=>{dragIdx=null;cd.classList.remove("dragging");};cd.ondragover=e=>{e.preventDefault();cd.classList.add("drag-over");};cd.ondragleave=()=>cd.classList.remove("drag-over");cd.ondrop=e=>{e.preventDefault();cd.classList.remove("drag-over");if(dragIdx!==null&&dragIdx!==idx){const mv=S.bills.splice(dragIdx,1)[0];S.bills.splice(idx,0,mv);sv();R();}};
      cd.appendChild(h("div",{style:{fontWeight:"700",fontSize:"14px",marginBottom:"6px"}},[b.n||""]));cd.appendChild(h("div",{style:{fontSize:"12px",color:"#666",marginBottom:"4px"}},["Due: "+dueDateStr]));cd.appendChild(h("div",{style:{fontSize:"16px",fontWeight:"700",color:"#e74c3c",marginBottom:"4px"}},[fm$(b.a)]));cd.appendChild(bg(b.recurrence,b.recurrence==="Monthly"?"#8e44ad":"#2980b9"));cd.appendChild(h("div",{style:{display:"flex",gap:"4px",alignItems:"center",justifyContent:"space-between",marginTop:"8px"}},[h("div",{style:{display:"flex",gap:"4px",alignItems:"center"}},[CK(b.paid,()=>{b.paid=!b.paid;sv();R();}),h("span",{style:{fontSize:"11px",color:"#666"}},[b.paid?"Paid":"Unpaid"])]),h("div",{style:{display:"flex",gap:"4px"}},[$("‚úèÔ∏è",()=>{const bf={n:b.n,recurrence:b.recurrence,day:b.day||"",date:b.date||"",a:b.a};const recSelEdit=sl(b.recurrence,v=>{bf.recurrence=v;const editDateInput=document.getElementById("editBillDateInput");const editDayInput=document.getElementById("editBillDayInput");if(editDateInput&&editDayInput){if(v==="One-time"){editDateInput.style.display="block";editDayInput.style.display="none";}else{editDateInput.style.display="none";editDayInput.style.display="block";}}},[{value:"Monthly",label:"Monthly"},{value:"One-time",label:"One-time"}]);const editDayInput=ip("number",b.day||"",v=>bf.day=v,"Due day (1-31)");editDayInput.id="editBillDayInput";if(b.recurrence==="One-time")editDayInput.style.display="none";const editDateInput=ip("date",b.date||"",v=>bf.date=v,"Due date");editDateInput.id="editBillDateInput";if(b.recurrence==="Monthly")editDateInput.style.display="none";const bm=ml("Edit Bill",h("div",{style:{display:"flex",flexDirection:"column",gap:"8px"}},[ip("text",b.n,v=>bf.n=v,"Name"),recSelEdit,editDayInput,editDateInput,ip("number",b.a,v=>bf.a=v,"Amount"),$("Save",()=>{b.n=bf.n;b.recurrence=bf.recurrence;b.day=bf.recurrence==="Monthly"?bf.day:null;b.date=bf.recurrence==="One-time"?bf.date:null;b.a=bf.a;b.lastEdited=TD;sv();bm.remove();R();},"B Bp")]));},"",{background:"none",border:"none",cursor:"pointer",color:P,fontSize:"12px"}),DL(()=>{S.bills=S.bills.filter(x=>x.id!==b.id);sv();R();})])]));gr.appendChild(cd);});w.appendChild(gr);
  }else if(S.u.ht==="rem"){(S.rem||[]).forEach(r=>{w.appendChild(C([h("div",{style:{display:"flex",justifyContent:"space-between",width:"100%"}},[h("div",{},[h("strong",{},[r.text||""]),r.date?h("div",{style:{fontSize:"12px",color:"#666"}},["üìÖ"+fmt(r.date)]):null]),h("div",{style:{display:"flex",gap:"4px"}},[$("‚úèÔ∏è",()=>{const rf={text:r.text,date:r.date||TD};const rm=ml("Edit Reminder",h("div",{style:{display:"flex",flexDirection:"column",gap:"8px"}},[ip("text",r.text,v=>rf.text=v,"Reminder"),ip("date",r.date||TD,v=>rf.date=v),$("Save",()=>{r.text=rf.text;r.date=rf.date;r.lastEdited=TD;sv();rm.remove();R();},"B Bp")]));},"",{background:"none",border:"none",cursor:"pointer",color:P,fontSize:"12px"}),DL(()=>{S.rem=S.rem.filter(x=>x.id!==r.id);sv();R();})])])],{padding:"10px"}));});w.appendChild($("+ Reminder",()=>{const f={text:"",date:TD};const m=ml("Add",h("div",{style:{display:"flex",flexDirection:"column",gap:"8px"}},[ip("text","",v=>f.text=v,"Reminder"),ip("date",TD,v=>f.date=v),$("Add",()=>{if(!f.text)return;S.rem.push({id:uid(),...f,created:TD});sv();m.remove();R();},"B Bp")]));},"Bs Bp"));
  }else if(S.u.ht==="maint"){(S.maint||[]).forEach(m=>{w.appendChild(C([h("div",{style:{display:"flex",justifyContent:"space-between",width:"100%"}},[h("div",{},[h("strong",{},[m.task||""]),h("div",{style:{fontSize:"12px",color:"#666"}},[m.status||"Not Started"])]),h("div",{style:{display:"flex",gap:"4px"}},[$("‚úèÔ∏è",()=>{const mf={task:m.task,status:m.status||"Not Started"};const mm=ml("Edit",h("div",{style:{display:"flex",flexDirection:"column",gap:"8px"}},[ip("text",m.task,v=>mf.task=v,"Task"),sl(m.status||"Not Started",v=>mf.status=v,["Not Started","In Progress","Complete","On Hold"]),$("Save",()=>{m.task=mf.task;m.status=mf.status;m.lastEdited=TD;sv();mm.remove();R();},"B Bp")]));},"",{background:"none",border:"none",cursor:"pointer",color:P,fontSize:"12px"}),sl(m.status||"Not Started",v=>{m.status=v;sv();R();},["Not Started","In Progress","Complete","On Hold"]),DL(()=>{S.maint=S.maint.filter(x=>x.id!==m.id);sv();R();})])])],{padding:"10px"}));});w.appendChild($("+ Task",()=>{const f={task:"",status:"Not Started"};const m_t=ml("Add Task",h("div",{style:{display:"flex",flexDirection:"column",gap:"8px"}},[ip("text","",v=>f.task=v,"Task"),$("Add",()=>{if(!f.task.trim())return;S.maint.push({id:uid(),...f,date:TD});sv();m_t.remove();R();},"B Bp")]));},"Bs Bp"));
  }else if(S.u.ht==="subs"){(S.subs||[]).forEach(s=>{const ni=ip("text",s.name||"",v=>{s.name=v;sv();});ni.style.cssText="font-weight:600;border:none";w.appendChild(C([h("div",{style:{display:"flex",alignItems:"center",gap:"8px",width:"100%"}},[ni,DL(()=>{S.subs=S.subs.filter(x=>x.id!==s.id);sv();R();})])],{padding:"10px"}));});w.appendChild($("+ Sub",()=>{S.subs.push({id:uid(),name:"New"});sv();R();},"Bs Bp"));
  }else if(S.u.ht==="checklist"){rHouseCk(w);
  }else if(S.u.ht==="links"){linksSec(w,"homeLinks","üîó Home Custom Links");}}
function rHouseCk(w){const ck=S.houseCk||[];const dn=ck.filter(i=>i.done).length;w.appendChild(H("Before Leaving House",[$("Reset All",()=>{ck.forEach(i=>i.done=0);sv();R();},"Bs Bo")]));const c=C([]);ck.forEach(i=>{const itemDiv=h("div",{style:{display:"grid",gridTemplateColumns:"auto 1fr auto",gap:"8px",alignItems:"center",padding:"8px 0",borderBottom:"1px solid #eee",width:"100%"}});itemDiv.appendChild(CK(i.done,()=>{i.done=i.done?0:1;sv();R();}));itemDiv.appendChild(ED(i.text||"Untitled",v=>{i.text=v;sv();R();}));const btnBox=h("div",{style:{display:"flex",gap:"4px"}});btnBox.appendChild($("‚úèÔ∏è",()=>{const v=prompt("Edit:",i.text);if(v){i.text=v;sv();R();}},"",{background:"none",border:"none",cursor:"pointer",fontSize:"11px",color:P}));btnBox.appendChild(DL(()=>{S.houseCk=S.houseCk.filter(x=>x.id!==i.id);sv();R();}));itemDiv.appendChild(btnBox);c.appendChild(itemDiv);});c.appendChild(AI("Add checklist item...",v=>{S.houseCk.push({id:uid(),text:v,done:0});sv();}));c.appendChild(h("div",{style:{marginTop:"12px",textAlign:"center"}},[h("div",{style:{fontSize:"13px",fontWeight:"700",color:dn===ck.length&&ck.length?"#27ae60":"#e74c3c"}},[dn+"/"+ck.length+" complete"]),PB(ck.length?Math.round(dn/ck.length*100):0,dn===ck.length&&ck.length?"#27ae60":"#2980b9")]));w.appendChild(c);}

// ‚îÄ‚îÄ She-Hulk (Athletics) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function rSH(w){w.appendChild(SB([["rowing","üö£ Rowing"],["throwing","üèãÔ∏è Throwing"],["nut","ü•ó Nutrition"],["wk","üí™ Workouts"]],S.u.sk,v=>{S.u.sk=v;R();}));
  if(S.u.sk==="rowing"){w.appendChild(SB([["gear","‚öì Gear"],["acr","üéØ ACR"],["links","üîó Links"]],S.u.rs,v=>{S.u.rs=v;R();}));if(S.u.rs==="gear")gearL(w,S.rGear,v=>{S.rGear=v;sv();},"üö£ Rowing Gear");else if(S.u.rs==="links")linksSec(w,"rowLinks","üîó Rowing Custom Links");else acrV(w,(S.acr||[]).filter(a=>!a.s.startsWith("Highland")));
  }else if(S.u.sk==="throwing"){w.appendChild(SB([["gear","üèãÔ∏è Gear"],["hg","‚öîÔ∏è Highland Games"],["links","üîó Links"]],S.u.tw,v=>{S.u.tw=v;R();}));if(S.u.tw==="gear")gearL(w,S.tGear,v=>{S.tGear=v;sv();},"üèãÔ∏è Throwing Gear");else if(S.u.tw==="links")linksSec(w,"throwLinks","üîó Throwing Custom Links");else acrV(w,(S.acr||[]).filter(a=>a.s.startsWith("Highland")));
  }else if(S.u.sk==="nut"){const tip=C([],{background:"#f0f4ff",padding:"8px 12px"});tip.innerHTML='<div style="font-size:12px;color:'+P+'">üí° <a href="https://cronometer.com" target="_blank" style="color:'+P+'"><strong>Open Cronometer ‚Üí</strong></a></div>';w.appendChild(tip);
    const tm=(S.meals||[]).filter(m=>m.date===TD),tot=tm.reduce((s,m)=>({cal:s.cal+Number(m.cal||0),pro:s.pro+Number(m.pro||0),carbs:s.carbs+Number(m.carbs||0),fat:s.fat+Number(m.fat||0)}),{cal:0,pro:0,carbs:0,fat:0});
    const sg=h("div",{style:{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:"8px",textAlign:"center"}});[["Cal",tot.cal,"#e74c3c"],["Pro",tot.pro+"g","#2980b9"],["Carbs",tot.carbs+"g","#f39c12"],["Fat",tot.fat+"g","#8e44ad"]].forEach(([l,v,c])=>sg.appendChild(h("div",{style:{background:"#fff",borderRadius:"8px",padding:"8px"}},[h("div",{style:{fontSize:"20px",fontWeight:"700",color:c}},[String(v)]),h("div",{style:{fontSize:"11px",color:"#666"}},[l])])));w.appendChild(C([sg],{background:"#f0fff4"}));
    const f={name:"",cal:"",pro:"",carbs:"",fat:""};w.appendChild(C([ip("text","",v=>f.name=v,"Meal"),h("div",{class:"g2",style:{marginTop:"8px"}},[ip("number","",v=>f.cal=v,"Cal"),ip("number","",v=>f.pro=v,"Protein g"),ip("number","",v=>f.carbs=v,"Carbs g"),ip("number","",v=>f.fat=v,"Fat g")]),$("Log",()=>{if(!f.name)return;S.meals.unshift({...f,id:uid(),date:TD,created:TD});sv();R();},"B Bp",{marginTop:"8px"})]));
    tm.forEach(m=>{w.appendChild(C([h("div",{style:{display:"flex",justifyContent:"space-between",width:"100%"}},[h("strong",{},[m.name||""]),h("div",{style:{display:"flex",gap:"8px",alignItems:"center"}},[$("‚úèÔ∏è",()=>{const mf={name:m.name,cal:m.cal||"",pro:m.pro||"",carbs:m.carbs||"",fat:m.fat||""};const mm=ml("Edit Meal",h("div",{style:{display:"flex",flexDirection:"column",gap:"8px"}},[ip("text",m.name,v=>mf.name=v,"Meal"),h("div",{class:"g2"},[ip("number",m.cal||"",v=>mf.cal=v,"Cal"),ip("number",m.pro||"",v=>mf.pro=v,"Protein g"),ip("number",m.carbs||"",v=>mf.carbs=v,"Carbs g"),ip("number",m.fat||"",v=>mf.fat=v,"Fat g")]),$("Save",()=>{m.name=mf.name;m.cal=mf.cal;m.pro=mf.pro;m.carbs=mf.carbs;m.fat=mf.fat;m.lastEdited=TD;sv();mm.remove();R();},"B Bp")]));},"",{background:"none",border:"none",cursor:"pointer",color:P,fontSize:"12px"}),h("span",{style:{fontSize:"12px",color:"#666"}},[[m.cal&&m.cal+"cal",m.pro&&m.pro+"g"].filter(Boolean).join(" ¬∑ ")]),DL(()=>{S.meals=S.meals.filter(x=>x.id!==m.id);sv();R();})])])],{padding:"10px"}));});
  }else{const tip=C([],{background:"#f0f4ff",padding:"8px 12px"});tip.innerHTML='<div style="font-size:12px;color:'+P+'">üí° <a href="https://truecoach.co" target="_blank" style="color:'+P+'"><strong>Open TrueCoach ‚Üí</strong></a></div>';w.appendChild(tip);
    w.appendChild(H("Schedule",[$("+ Schedule",()=>{const f={type:"Walk",dur:"",unit:"min",date:TD,time:""};const m=ml("Schedule Workout",h("div",{style:{display:"flex",flexDirection:"column",gap:"10px"}},[FL("Type",sl("Walk",v=>f.type=v,WT)),h("div",{class:"g2"},[FL("Duration",ip("number","",v=>f.dur=v,"30")),FL("Unit",sl("min",v=>f.unit=v,["min","mi"]))]),h("div",{class:"g2"},[FL("Date",ip("date",TD,v=>f.date=v)),FL("Time",ip("time","",v=>f.time=v))]),$("Schedule",()=>{if(!S.swk)S.swk=[];S.swk.push({id:uid(),...f,done:0,created:TD});sv();m.remove();R();},"B Bp")]));},"Bs Bp")]));
    (S.swk||[]).filter(x=>x.date>=TD).sort((a,b)=>a.date.localeCompare(b.date)).forEach(x=>{w.appendChild(C([h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",width:"100%"}},[h("div",{},[h("strong",{},[x.type||""]),h("div",{style:{fontSize:"12px",color:"#666"}},[fmt(x.date)+(x.time?" ¬∑ "+x.time:"")+(x.dur?" ¬∑ "+x.dur+(x.unit==="mi"?"mi":"min"):"")])]),h("div",{style:{display:"flex",gap:"4px"}},[$("‚úèÔ∏è",()=>{const xf={type:x.type,dur:x.dur||"",unit:x.unit||"min",date:x.date,time:x.time||""};const xm=ml("Edit Workout",h("div",{style:{display:"flex",flexDirection:"column",gap:"10px"}},[FL("Type",sl(x.type,v=>xf.type=v,WT)),h("div",{class:"g2"},[FL("Duration",ip("number",x.dur||"",v=>xf.dur=v,"30")),FL("Unit",sl(x.unit||"min",v=>xf.unit=v,["min","mi"]))]),h("div",{class:"g2"},[FL("Date",ip("date",x.date,v=>xf.date=v)),FL("Time",ip("time",x.time||"",v=>xf.time=v))]),$("Save",()=>{x.type=xf.type;x.dur=xf.dur;x.unit=xf.unit;x.date=xf.date;x.time=xf.time;x.lastEdited=TD;sv();xm.remove();R();},"B Bp")]));},"",{background:"none",border:"none",cursor:"pointer",color:P,fontSize:"12px"}),x.done?bg("‚úì","#27ae60"):$("Done",()=>{x.done=1;sv();R();},"Bs Bg"),DL(()=>{S.swk=S.swk.filter(y=>y.id!==x.id);sv();R();})])])],{padding:"10px"}));});
    w.appendChild(H("Quick Log"));const f={type:"Lift",dur:"",notes:""};w.appendChild(C([h("div",{class:"g2"},[sl("Lift",v=>f.type=v,WT),ip("text","",v=>f.dur=v,"Duration")]),ta("",v=>f.notes=v,"Notes...",2),$("Log",()=>{if(!S.wk)S.wk=[];S.wk.unshift({...f,id:uid(),date:TD,created:TD});sv();R();},"B Bp",{marginTop:"8px"})]));
    (S.wk||[]).filter(x=>x.date===TD).forEach(x=>{w.appendChild(C([h("div",{style:{display:"flex",justifyContent:"space-between",width:"100%"}},[h("div",{},[h("strong",{},[x.type||""]),x.dur?h("span",{style:{fontSize:"12px",color:"#666",marginLeft:"8px"}},[x.dur]):null]),h("div",{style:{display:"flex",gap:"4px"}},[$("‚úèÔ∏è",()=>{const xf={type:x.type,dur:x.dur||"",notes:x.notes||""};const xm=ml("Edit",h("div",{style:{display:"flex",flexDirection:"column",gap:"8px"}},[h("div",{class:"g2"},[sl(x.type,v=>xf.type=v,WT),ip("text",x.dur||"",v=>xf.dur=v,"Duration")]),ta(x.notes||"",v=>xf.notes=v,"Notes...",2),$("Save",()=>{x.type=xf.type;x.dur=xf.dur;x.notes=xf.notes;x.lastEdited=TD;sv();xm.remove();R();},"B Bp")]));},"",{background:"none",border:"none",cursor:"pointer",color:P,fontSize:"12px"}),DL(()=>{S.wk=S.wk.filter(y=>y.id!==x.id);sv();R();})])])],{padding:"10px"}));});}}

// ‚îÄ‚îÄ Mind ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function rMind(w){w.appendChild(SB([["learn","üìö Learning"],["stories","üìñ Stories"]],S.u.mk,v=>{S.u.mk=v;R();}));if(S.u.mk==="learn"){rLn(w);}else{rSt(w);}}
function rLn(w){const CATS=["Journal Article","Drawing","Languages","Neuroscience"];w.appendChild(H("üìö Learning",[$("+ Project",()=>{const f={title:"",cat:"Journal Article",stage:"Not Started",notes:"",dueDate:""};const m=ml("Add Project",h("div",{style:{display:"flex",flexDirection:"column",gap:"10px"}},[ip("text","",v=>f.title=v,"Title"),h("div",{class:"g2"},[sl("Journal Article",v=>f.cat=v,CATS),sl("Not Started",v=>f.stage=v,ST)]),ip("date","",v=>f.dueDate=v,"Due Date (optional)"),ta("",v=>f.notes=v,"Notes...",2),$("Add",()=>{if(!f.title.trim())return;S.lP.push({id:uid(),...f,date:TD});sv();m.remove();R();},"B Bp")]));},"Bs Bp")]));
  w.appendChild(SB([["projects","üìö Projects"],["links","üîó Links"]],S.u.lf==="links"?"links":"projects",v=>{S.u.lf=v;R();}));
  if(S.u.lf==="links"){linksSec(w,"learnLinks","üîó Learning Custom Links");
  }else{(S.lP||[]).forEach(p=>{w.appendChild(C([h("div",{style:{display:"flex",justifyContent:"space-between",width:"100%"}},[h("div",{},[h("strong",{},[p.title||""]),bg(p.cat||"","#8e44ad"),bg(p.stage||""),p.dueDate?h("span",{style:{fontSize:"11px",color:"#888",marginLeft:"8px"}},["üìÖ"+fmt(p.dueDate)]):null]),h("div",{style:{display:"flex",gap:"4px"}},[$("‚úèÔ∏è",()=>{const pf={title:p.title,cat:p.cat,stage:p.stage,notes:p.notes||"",dueDate:p.dueDate||""};const ntx=ta(p.notes||"",v=>pf.notes=v,"Notes...",2);ntx.style.width="100%";const pm=ml("Edit",h("div",{style:{display:"flex",flexDirection:"column",gap:"10px"}},[ip("text",p.title,v=>pf.title=v,"Title"),h("div",{class:"g2"},[sl(p.cat,v=>pf.cat=v,CATS),sl(p.stage,v=>pf.stage=v,ST)]),ip("date",p.dueDate||"",v=>pf.dueDate=v,"Due Date"),ntx,$("Save",()=>{p.title=pf.title;p.cat=pf.cat;p.stage=pf.stage;p.notes=pf.notes;p.dueDate=pf.dueDate;p.lastEdited=TD;sv();pm.remove();R();},"B Bp")]));},"",{background:"none",border:"none",cursor:"pointer",color:P,fontSize:"12px"}),DL(()=>{S.lP=S.lP.filter(x=>x.id!==p.id);sv();R();})])])]));});
  if(!(S.lP||[]).length&&S.u.lf!=="links")w.appendChild(C([h("div",{style:{color:"#aaa",textAlign:"center",padding:"24px"}},["No projects."])]));}
}
function rSt(w){if(!S.jour)S.jour=[];w.appendChild(H("üìñ Stories"));const f={title:"",content:"",bucket:"Personal",mood:"",refDate:""};const txt=ta("",v=>f.content=v,"Write your reflection...",4);txt.style.width="100%";txt.id="storyTextArea";
  let recObj=null,listening=0;const vb=$("üéôÔ∏è Record",async()=>{if(listening){if(recObj)recObj.stop();listening=0;vb.textContent="üéôÔ∏è Record";vb.style.background="#27ae60";return;}try{await navigator.mediaDevices.getUserMedia({audio:true});}catch{alert("Microphone permission denied.");return;}const SR=window.SpeechRecognition||window.webkitSpeechRecognition;if(!SR){alert("Speech recognition not supported. Try Chrome or Edge.");return;}recObj=new SR();recObj.continuous=true;recObj.interimResults=false;recObj.lang="en-US";recObj.onresult=e=>{const transcript=Array.from(e.results).map(r=>r[0].transcript).join(" ");f.content=(f.content+(f.content?" ":"")+transcript);const textArea=document.getElementById("storyTextArea");if(textArea){textArea.value=f.content;}};recObj.onerror=err=>{console.error("Speech error:",err);listening=0;vb.textContent="üéôÔ∏è Record";vb.style.background="#27ae60";};recObj.onend=()=>{listening=0;vb.textContent="üéôÔ∏è Record";vb.style.background="#27ae60";};try{recObj.start();listening=1;vb.textContent="‚èπÔ∏è Stop";vb.style.background="#e74c3c";}catch(err){alert("Could not start mic: "+err.message);listening=0;}},"B Bg");
  const frLink=h("a",{href:"https://translate.google.com/?sl=auto&tl=fr&op=translate",target:"_blank",rel:"noopener noreferrer",style:{textDecoration:"none"}});frLink.appendChild($("üá´üá∑ French",()=>{},"B Bo"));
  w.appendChild(C([h("div",{class:"g2",style:{marginBottom:"8px"}},[ip("text","",v=>f.title=v,"Title"),sl("Personal",v=>f.bucket=v,BK),ip("text","",v=>f.mood=v,"Mood/tag"),ip("text","",v=>f.refDate=v,"Reference Date (note only)")]),txt,h("div",{style:{display:"flex",gap:"8px",marginTop:"8px"}},[$("Save",()=>{if(!f.content.trim())return;S.jour.unshift({id:uid(),title:f.title,content:f.content,bucket:f.bucket,mood:f.mood,refDate:f.refDate,date:TD,created:TD});sv();R();},"B Bp"),vb,frLink])]));
  (S.jour||[]).forEach(e=>{const c=C([],{borderLeft:"4px solid "+P});c.appendChild(h("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"4px",width:"100%"}},[h("div",{},[e.title?h("strong",{style:{marginRight:"8px"}},[e.title]):null,bg(e.bucket||"Personal",PL),e.mood?bg(e.mood,GL):null,e.refDate?h("span",{style:{fontSize:"11px",color:"#666",marginLeft:"8px"}},["üìù "+e.refDate]):null]),h("div",{style:{display:"flex",gap:"6px",alignItems:"center"}},[$("‚úèÔ∏è",()=>{const ef={title:e.title||"",content:e.content||"",bucket:e.bucket||"Personal",mood:e.mood||"",refDate:e.refDate||""};const etx=ta(e.content||"",v=>ef.content=v,"Content...",4);etx.style.width="100%";const em=ml("Edit Story",h("div",{style:{display:"flex",flexDirection:"column",gap:"8px"}},[h("div",{class:"g2"},[ip("text",e.title||"",v=>ef.title=v,"Title"),sl(e.bucket||"Personal",v=>ef.bucket=v,BK),ip("text",e.mood||"",v=>ef.mood=v,"Mood/tag"),ip("text",e.refDate||"",v=>ef.refDate=v,"Reference Date")]),etx,$("Save",()=>{e.title=ef.title;e.content=ef.content;e.bucket=ef.bucket;e.mood=ef.mood;e.refDate=ef.refDate;e.lastEdited=TD;sv();em.remove();R();},"B Bp")]));},"",{background:"none",border:"none",cursor:"pointer",color:P,fontSize:"12px"}),h("span",{style:{fontSize:"11px",color:"#888"}},[fmt(e.date)]),DL(()=>{S.jour=S.jour.filter(x=>x.id!==e.id);sv();R();})])]));c.appendChild(h("p",{style:{margin:0,fontSize:"14px",whiteSpace:"pre-wrap"}},[e.content||""]));if(e.lastEdited)c.appendChild(h("div",{style:{fontSize:"9px",color:"#888",marginTop:"4px",fontStyle:"italic"}},["Last edited: "+fmt(e.lastEdited)]));w.appendChild(c);});}

// ‚îÄ‚îÄ Blacksmith ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function rBS(w){w.appendChild(H("üî® Blacksmith",[$("+ Project",()=>{const f={name:"",notes:""};const m=ml("Add Project",h("div",{style:{display:"flex",flexDirection:"column",gap:"10px"}},[ip("text","",v=>f.name=v,"Name"),ta("",v=>f.notes=v,"Notes...",3),$("Add",()=>{if(!f.name.trim())return;if(!S.bsP)S.bsP=[];S.bsP.push({id:uid(),name:f.name,notes:[],tasks:[],stage:"Not Started",date:TD});sv();m.remove();R();},"B Bp")]));},"Bs Bp")]));
  w.appendChild(SB([["checklist","üìã Gear"],["projects","üî® Projects"],["pdfs","üìÑ PDFs"],["links","üîó Links"]],S.u.bss,v=>{S.u.bss=v;R();}));
  if(S.u.bss==="checklist")gearL(w,S.bsG,v=>{S.bsG=v;sv();},"Gear Checklist");
  else if(S.u.bss==="projects"){(S.bsP||[]).forEach(p=>{const op=S.u.bsx===p.id;const c=C([],{borderLeft:"4px solid "+GL});const ss=sl(p.stage,v=>{p.stage=v;sv();R();},ST);ss.style.fontSize="11px";c.appendChild(h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",cursor:"pointer",width:"100%"},onclick:()=>{S.u.bsx=op?null:p.id;R();}},[h("div",{},[h("span",{style:{fontWeight:"700"}},[p.name||""]),bg(p.stage||"",p.stage==="Complete"?"#27ae60":P)]),h("div",{style:{display:"flex",gap:"4px"},onclick:e=>e.stopPropagation()},[ss,$("‚úèÔ∏è",()=>{const pn=prompt("Edit project name:",p.name);if(pn!==null&&pn.trim()){p.name=pn.trim();p.lastEdited=TD;sv();R();}},"",{background:"none",border:"none",cursor:"pointer",color:P,fontSize:"12px"}),DL(()=>{S.bsP=S.bsP.filter(x=>x.id!==p.id);sv();R();})])]));if(op){const bd=h("div",{style:{marginTop:"10px",width:"100%"}});(p.notes||[]).forEach(n=>{const noteDiv=h("div",{style:{background:"#f9f9f9",borderRadius:"6px",padding:"6px",marginBottom:"4px",fontSize:"12px",display:"flex",justifyContent:"space-between",alignItems:"start",gap:"6px"}});noteDiv.appendChild(h("span",{style:{flex:"1"}},[fmt(n.date)+" ‚Äì "+(n.text||"")]));noteDiv.appendChild($("‚úèÔ∏è",()=>{const nt=prompt("Edit note:",n.text);if(nt!==null&&nt.trim()){n.text=nt.trim();n.lastEdited=TD;sv();R();}},"",{background:"none",border:"none",cursor:"pointer",color:P,fontSize:"11px"}));noteDiv.appendChild(DL(()=>{p.notes=p.notes.filter(x=>x.id!==n.id);sv();R();}));bd.appendChild(noteDiv);});bd.appendChild(AI("Add note...",v=>{if(!p.notes)p.notes=[];p.notes.push({id:uid(),text:v,date:TD});sv();}));if(p.lastEdited)bd.appendChild(h("div",{style:{fontSize:"9px",color:"#888",marginTop:"6px",fontStyle:"italic"}},["Last edited: "+fmt(p.lastEdited)]));c.appendChild(bd);}w.appendChild(c);});if(!(S.bsP||[]).length)w.appendChild(C([h("div",{style:{color:"#aaa",textAlign:"center"}},["No projects."])]));
  }else if(S.u.bss==="pdfs"){const c=C([]);(S.bsPdf||[]).forEach(p=>{c.appendChild(h("div",{style:{display:"flex",justifyContent:"space-between",padding:"7px 0",borderBottom:"1px solid #eee",width:"100%"}},[h("span",{},["üìÑ "+(p.name||"")]),h("div",{style:{display:"flex",gap:"6px"}},[$("View",()=>ml(p.name,h("iframe",{src:p.data,style:{width:"100%",height:"500px",border:"none"}})),"Bs Bp"),DL(()=>{S.bsPdf=S.bsPdf.filter(x=>x.id!==p.id);sv();R();})])]));});const fi=h("input",{type:"file",accept:"application/pdf",style:{display:"none"}});fi.onchange=e=>{const file=e.target.files[0];if(!file)return;const r=new FileReader();r.onload=ev=>{if(!S.bsPdf)S.bsPdf=[];S.bsPdf.push({id:uid(),name:file.name,data:ev.target.result,date:TD});sv();R();};r.readAsDataURL(file);};const lbl=h("label",{style:{display:"inline-block",marginTop:"8px",cursor:"pointer"}});lbl.appendChild($("‚¨ÜÔ∏è Upload PDF",()=>fi.click(),"Bs Bg"));c.appendChild(lbl);c.appendChild(fi);w.appendChild(c);
  }else{linksSec(w,"bsLinks","üîó Blacksmith Custom Links");}}

// ‚îÄ‚îÄ Settings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function rSet(w){w.appendChild(H("‚öôÔ∏è Settings"));
  w.appendChild(C([h("div",{style:{fontWeight:"700",marginBottom:"8px"}},["Device Name"]),ip("text",S.settings.deviceName||"MyDevice",v=>{S.settings.deviceName=v;sv();})]));

  // PWA Status card
  const pwac=C([],{background:"#f0f4ff"});pwac.appendChild(h("div",{style:{fontWeight:"700",marginBottom:"8px",color:P}},["üì± PWA Status"]));
  const onRealOrigin=(location.protocol==='https:'||location.protocol==='http:');
  const swSt="‚ö†Ô∏è SW requires a separate sw.js file on a web server";
  const mfStatus=document.getElementById('manifestLink')?.href&&onRealOrigin?"‚úÖ Manifest active (installable on http/https)":"‚ö†Ô∏è Manifest requires http/https to activate";
  pwac.appendChild(h("div",{style:{fontSize:"12px",lineHeight:"2"}},[swSt]));
  pwac.appendChild(h("div",{style:{fontSize:"12px",lineHeight:"2"}},[mfStatus]));
  pwac.appendChild(h("div",{style:{fontSize:"11px",color:"#e67e22",marginTop:"4px",fontWeight:"600"}},["Full PWA (offline + install) requires hosting on a server. Easy options: GitHub Pages, Netlify, or run locally with: python3 -m http.server"]));
  w.appendChild(pwac);

  const cc=C([]);cc.appendChild(h("div",{style:{fontWeight:"700",marginBottom:"8px"}},["üîí Encrypted Credentials"]));cc.appendChild($(S.u.sc?"Hide":"Show",async()=>{
    if(!S.u.sc&&S.pw){
      const p=prompt("Master password:");
      if(!p)return;
      const h256=await hashPw(p);
      if(h256!==S.pw){alert("Wrong password.");return;}
      S._sessionPw=p;
    }
    S.u.sc=!S.u.sc;R();
  },"Bs Bo"));
  if(S.u.sc){const d=h("div",{style:{marginTop:"10px",display:"flex",flexDirection:"column",gap:"8px"}});[["gmail1","Gmail Personal"],["gmail2","Gmail WF"],["gmail3","Gmail Academic"],["cronometer","Cronometer"],["truecoach","TrueCoach"]].forEach(([k,l])=>{const row=h("div",{},[h("label",{class:"fl"},[l])]);const inp=ip("password","",()=>{},"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢");inp.placeholder="Loading‚Ä¶";(async()=>{inp.value=S.creds[k]&&S._sessionPw?await dec(S.creds[k],S._sessionPw):'';inp.placeholder=l;})();inp.onchange=async()=>{if(inp.value&&S._sessionPw){S.creds[k]=await enc(inp.value,S._sessionPw);sv();}};row.appendChild(inp);d.appendChild(row);});d.appendChild(h("p",{style:{fontSize:"11px",color:"#888",margin:0}},["üîí AES-256 encrypted. Only decryptable with your password."]));cc.appendChild(d);}w.appendChild(cc);
  const lc=C([]);lc.appendChild(h("div",{style:{fontWeight:"700",marginBottom:"8px"}},["üîó Quick Links"]));[["Gmail","https://mail.google.com"],["Google Calendar","https://calendar.google.com"],["Google Drive","https://drive.google.com"],["TrueCoach","https://truecoach.co"],["Cronometer","https://cronometer.com"]].forEach(([l,u])=>lc.appendChild(lr(l,u)));w.appendChild(lc);
  const dc=C([]);dc.appendChild(h("div",{style:{fontWeight:"700",marginBottom:"8px"}},["üì¶ Data ‚Äì Export/Import"]));dc.appendChild(h("p",{style:{fontSize:"12px",color:"#555",margin:"0 0 10px"}},["Non-destructive import: keeps existing, adds new."]));
  dc.appendChild($("‚¨áÔ∏è Export",()=>{const d={};KS.forEach(k=>d[k]=S[k]);d.exportDate=new Date().toISOString();d.device=S.settings.deviceName;const a=document.createElement("a");a.href="data:application/json,"+encodeURIComponent(JSON.stringify(d,null,2));a.download="tardis-"+(S.settings.deviceName||"device")+"-"+TD+".json";a.click();},"B Bp",{marginRight:"8px"}));
  const fi=h("input",{type:"file",style:{display:"none"}});fi.onchange=e=>{const file=e.target.files[0];if(!file)return;const r=new FileReader();r.onload=ev=>{try{const d=JSON.parse(ev.target.result);let at=0;if(d.tasks){const mp=new Map((S.tasks||[]).map(x=>[x.id,x]));d.tasks.forEach(t=>{if(!mp.has(t.id)){mp.set(t.id,t);at++;}});S.tasks=Array.from(mp.values());}if(d.rec){const ids=new Set((S.rec||[]).map(x=>x.id));d.rec.filter(x=>!ids.has(x.id)).forEach(x=>{if(!S.rec)S.rec=[];S.rec.push(x);});}sv();R();alert("‚úÖ Imported! "+at+" new tasks.");}catch{alert("Failed.");}};r.readAsText(file);};
  dc.appendChild($("‚¨ÜÔ∏è Import",()=>fi.click(),"B Bg"));dc.appendChild(fi);dc.appendChild(h("div",{style:{marginTop:"10px",fontSize:"13px",color:"#666"}},["Tasks: "+(S.tasks||[]).length+" ¬∑ Recurring: "+(S.rec||[]).length]));w.appendChild(dc);
  const dz=C([]);dz.appendChild(h("div",{style:{fontWeight:"700",marginBottom:"8px",color:"#e74c3c"}},["‚ö†Ô∏è Danger Zone"]));dz.appendChild($("Clear All Tasks",()=>{if(confirm("Clear ALL tasks?"))S.tasks=[];sv();R();},"B Bd"));w.appendChild(dz);}

ld().then(()=>R());
</script></body></html>
